# Exploring a Single Table (asking Business Questions) {#chapter_exploring-a-single-table}

> This chapter demonstrates how to:
>
>   * Investigate a database from a business perspective
>   * Show the multiple data anomalies found in a single Advenureworks table
>   * Dig into a single Adventureworks table containing sales data
>   * Investigate the data from a business value perspective

The previous chapter has demonstrated some of the automated techniques for showing what's in a table using specific R functions and packages.  Now we demonstrate a step-by-step process of making sense of what's in one table with more of a business perspective.  We illustrate the kind of detective work that's often involved as we investigate the meaning of the meaning in a table.  We'll investigate the `salesorderheader` table in the `sales` schema in this example with an eye on the AdventureWorks busieness' sales.  We show that there are quite a few interpretation issues even when we are examining just 3 out of the 25 columns in the `salesorderheader` table.

For this kind of detective work we are seeking to undertand the following elements separately and as they interact with each other (and they all do):

  * The data that's stored in the database and how information is represented
  * How the data is entered at a day-to-day level to represent business activities
  * How the business itself is changing

## Setup our standard working environment

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 10)
sleep_default <- 3
```

Use these libraries:
```{r libraries, message=FALSE}
library(tidyverse)
library(DBI)
library(RPostgres)
library(glue)
require(knitr)
library(dbplyr)
library(sqlpetr)
library(bookdown)
library(here)
library(lubridate)
library(gt)

library(scales) # ggplot xy scales
theme_set(theme_light())
```

Connect to `adventureworks`:
```{r, start adventureworks and connect}
sp_docker_start("adventureworks")
Sys.sleep(sleep_default)
con <- sp_get_postgres_connection(
  host = "localhost",
  port = 5432,
  user = "postgres",
  password = "postgres",
  dbname = "adventureworks",
  seconds_to_test = sleep_default, connection_tab = TRUE
)
```

## A word on naming 

> You will find that many columns have the same name in an enterprise database.  For example, in the adventureworks database, almost all tables have columns named `rowguid` and `modifieddate` and there are many other examples of names that are reused.  The meaning of a columns depends on the table that contains it, so as you pull a column out of a table, naming its provenance is important.
>
> Naming columns carefully (whether retrieved from the database or calculated)  will pay off, especially as our queries become more complex. Using `soh` to tag statistics that are derived from the `salesorderheader` table as we do in this book is one example of an intentional naming strategy: it reminds you  of the original source of a column.  You, future you, and your collaborators will appreciate the effort although different naming conventions are completely valid.  And a naming convention when rigidly applied can yield some long and uggly names.
>
> In the following example `soh` appears in different positions in the column name but it is easy to guess at a glance that the data comes from the `salesorderheader` table.
>
> Naming derived tables is just as important as naming derived columns.

## The overall AdventureWorks sales picture

## Annual sales

On an annual basis, are sales dollars trending up, down or flat? We begin with total revenue and number of orders at different levels of detail.  

```{r Calculate time period and annual sales dollars- 1}
annual_sales <- tbl(con, in_schema("sales", "salesorderheader")) %>% 
  mutate(year = substr(as.character(orderdate), 1, 4)) %>%
  group_by(year) %>%
  summarize(
    min_soh_orderdate = min(orderdate, na.rm = TRUE),
    max_soh_orderdate = max(orderdate, na.rm = TRUE),
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  ) %>%
  arrange(year) %>%
  select(
    year, min_soh_orderdate, max_soh_orderdate, total_soh_dollars,
    avg_total_soh_dollars, soh_count
  ) %>%
  show_query() %>%
  collect()

annual_sales
```

Both 2011 and 2014 are shorter time spans than the other two years, making comparison across the years more difficult. We might normalize the totals based on the number of months in each year, but we first graph total dollars:

### Total sales by year

```{r Calculate time period and annual sales dollars - 2}
min_soh_dt <- min(annual_sales$min_soh_orderdate)
max_soh_dt <- max(annual_sales$max_soh_orderdate)

ggplot(data = annual_sales, aes(x = year, y = total_soh_dollars)) +
  geom_col() +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Adventure Works Sales Dollars by Year",
    x = paste("Year - between ", min_soh_dt, " - ", max_soh_dt),
    y = "Sales $"
  )
```

From 2011 through 2013, sales are trending up. Are sales dollars for 2014 really down, is it a shorter year (are sales seasonal)?  To see if the sales dollars are seasonal, we will drill in and look at the monthly sales.  But first, let's look at the number of orders and whether there's a pattern in the sales data.  

### Total order volume

Look at number of orders per year:
```{r average dollars per sale - v2}
ggplot(data = annual_sales, aes(x = year, y = as.numeric(soh_count))) +
  geom_col() +
  labs(
    title = "Number of orders per year",
    x = paste("Years between ", min_soh_dt, " - ", max_soh_dt),
    y = "Total Number of Orders"
  )
```

That's a huge jump in the number of orders between 2012 and 2013.  Given the total annual dollars, we ask whether the size of a sale has changed.

### Average dollars per sale

```{r average dollars per sale - }
ggplot(data = annual_sales, aes(x = year, y = avg_total_soh_dollars)) +
  geom_col() +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Average Dollars per Sale",
    x = paste("Year - between ", min_soh_dt, " - ", max_soh_dt),
    y = "Average Sale Amount"
  )
```

That's a remarkable drop between average sale of more than $7,000 to less than $3,000.  Some kind of remarkable change has taken place in this business.

From 2012 to 2013 the average dollars per order dropped from more than $8,500 to nearly $3,000 while the total number of order shot up from less than 4,000 to more than 14,000.  **Why are the number of orders increasing, but the average dollar amount of a sale is dropping?  **

We need to drill down to look at monthly sales, adapting the first query to group by month and year.

## Monthly Sales

Our next investigation drills down from annual sales dollars to monthly sales dollars. For that we download the orderdate, rather than a character variable for the year.  R handles the coversion from the PostgreSQL date-time to an R date-time.  We then convert it to a simple date with a `lubridate` function.

```{r monthly sales retrieval}
monthly_sales <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal) %>%
  collect() %>% # From here on we're in R

  mutate(
    orderdate = date(orderdate),
    orderdate = round_date(orderdate, "month")
  ) %>%
  group_by(orderdate) %>%
  summarize(
    min_soh_orderdate = min(orderdate, na.rm = TRUE),
    max_soh_orderdate = max(orderdate, na.rm = TRUE),
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  )
```

Plotting the monthly sales data:

```{r Total monthly sales bar chart}

ggplot(data = monthly_sales, aes(x = orderdate, y = total_soh_dollars)) +
  geom_col() +
  scale_y_continuous(labels = dollar) +
  theme(plot.title = element_text(hjust = 0.5)) + # Center the title
  labs(
    title = paste("Sales by Month\n", min_soh_dt, " - ", max_soh_dt),
    x = "Month",
    y = "Sales Dollars"
  )
```

### Check lagged monthly data

The total sales are trending up but suspiciously uneven.  Looking at lags might confirm just how much month-to-month difference there is:

```{r}
monthly_sales_lagged <- monthly_sales %>%
  mutate(monthly_sales_change = (lag(total_soh_dollars, 1)) -
    total_soh_dollars)
```

```{r}
(sum_lags <- summary(monthly_sales_lagged$monthly_sales_change))
```

The trend is positive on average `r prettyNum(sum_lags[["Mean"]], big.mark = ",", format = "f", digits = 0)` but half of the months have swings great than `r prettyNum(sum_lags[["3rd Qu."]] - sum_lags[["1st Qu."]], big.mark = ",", format = "f", digits = 0)`!


```{r}
ggplot(monthly_sales_lagged, aes(x = orderdate, y = monthly_sales_change)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y", date_minor_breaks = "3 months") +
  geom_line() +
  scale_y_continuous(labels = scales::dollar_format()) +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Monthly Sales Change \n",
      "Between ", min_soh_dt, " and ", max_soh_dt
    ),
    x = "Month",
    y = "Dollar Change"
  )
```

AventureWorks sales are *very* uneven.

### Comparing dollars and orders to a base year

To look at dollars and the number of orders together, we compare the monthly data to the yearly average for 2011.

```{r}
start_year <- monthly_sales %>%
  mutate(yr = year(orderdate)) %>%
  group_by(yr) %>%
  summarize(
    total_soh_dollars = sum(total_soh_dollars),
    soh_count = sum(soh_count),
    n_months = n(),
    avg_dollars = total_soh_dollars / n_months,
    avg_count = soh_count / n_months
  ) %>%
  filter(yr == min(yr))
```

Use 2011 as a baseline:

```{r}
start_year
```

Re express monthly data in terms of the baseline and plot:

```{r}
monthly_sales_base_year_normalized_to_2011 <- monthly_sales %>%
  mutate(
    dollars = (100 * total_soh_dollars) / start_year$avg_dollars,
    number_of_orders = (100 * soh_count) / start_year$avg_count
  ) %>%
  ungroup()

monthly_sales_base_year_normalized_to_2011 <- monthly_sales_base_year_normalized_to_2011 %>%
  select(orderdate, dollars, number_of_orders) %>%
  pivot_longer(-orderdate,
    names_to = "relative_to_2011_average",
    values_to = "amount"
  )

monthly_sales_base_year_normalized_to_2011 %>%
  ggplot(aes(orderdate, amount, color = relative_to_2011_average)) +
  geom_line() +
  geom_hline(yintercept = 100) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "6 months") +
  labs(
    title = paste(
      "Adventureworks Normalized Monthly Sales\n",
      "Number of Sales Orders and Dollar Totals\n",
      min_soh_dt, " to ", max_soh_dt
    ),
    x = "Date",
    y = "",
    color = "% change from\n 2011 average"
  )
```

## The effect of online sales

We have suspected that the business has changed a lot with the advent of online orders so we check the impact of `onlineorderflag` on annual sales.  The `onlineorderflag` indicates which sales channel accounted for the sale, **Sales Reps** or **Online**.

### Add `onlineorderflag` to our annual sales query

```{r Calculate time period and annual sales dollars- 3}
annual_sales_w_channel <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal, onlineorderflag) %>%
  collect() %>%
  mutate(
    orderdate = date(orderdate),
    orderdate = round_date(orderdate, "year"),
    onlineorderflag = if_else(onlineorderflag == FALSE,
      "Sales Rep", "Online"
    ),
    onlineorderflag = as.factor(onlineorderflag)
  ) %>%
  group_by(orderdate, onlineorderflag) %>%
  summarize(
    min_soh_orderdate = min(orderdate, na.rm = TRUE),
    max_soh_orderdate = max(orderdate, na.rm = TRUE),
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  ) %>%
  select(
    orderdate, onlineorderflag, min_soh_orderdate,
    max_soh_orderdate, total_soh_dollars,
    avg_total_soh_dollars, soh_count
  )
```

### Annual Sales comparison

Start by looking at total sales.

```{r Calculate time period and annual sales dollars - 5}

ggplot(data = annual_sales_w_channel, aes(x = orderdate, y = total_soh_dollars)) +
  geom_col() +
  scale_y_continuous(labels = scales::dollar_format()) +
  facet_wrap("onlineorderflag") +
  labs(
    title = "Adventure Works Sales Dollars by Year",
    caption = paste("Between", min_soh_dt, " an ", max_soh_dt),
    subtitle = "Comparing Online and Sales Rep sales channels",
    x = "Year",
    y = "Sales $"
  )
```

Indeed the total sales are quite different as are the number of orders and the average order size!

### Order volume comparison

Look at number of orders per year:
```{r average dollars per sale - v4}
ggplot(data = annual_sales_w_channel, aes(x = orderdate, y = as.numeric(soh_count))) +
  geom_col() +
  facet_wrap("onlineorderflag") +
  labs(
    title = "Adventure Works Number of orders per Year",
    caption = paste("Between", min_soh_dt, " an ", max_soh_dt),
    subtitle = "Comparing Online and Sales Rep sales channels",
    x = "Year",
    y = "Total number of orders"
  )
```

### Comparing Sales Rep sales to Online Orders

```{r average dollars per sale 3}
ggplot(data = annual_sales_w_channel, aes(x = orderdate, y = avg_total_soh_dollars)) +
  geom_col() +
  facet_wrap("onlineorderflag") +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Average Dollars per Sale",
    x = paste("Year, between", min_soh_dt, " and ", max_soh_dt),
    y = "Average sale amount"
  )
```


## Impact of order type on monthly sales

Digging into the difference between *Sales Rep* and *Online* sales. 

### Retrieve monthly sales with the `onlineorderflag` 

This query puts the `collect` statement earlier than the previous queries.

```{r}
monthly_sales_w_channel <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal, onlineorderflag) %>%
  collect() %>% # From here on we're in R

  mutate(
    orderdate = date(orderdate),
    orderdate_rounded = round_date(orderdate, "month"),
    onlineorderflag = if_else(onlineorderflag == FALSE,
      "Sales Rep", "Online"
    ),
  ) %>% #
  group_by(orderdate, onlineorderflag) %>%
  summarize(
    min_soh_orderdate = min(orderdate, na.rm = TRUE),
    max_soh_orderdate = max(orderdate, na.rm = TRUE),
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  ) %>%
  ungroup()
```


```{r}
monthly_sales_w_channel %>%
  rename(`Sales Channel` = onlineorderflag) %>%
  group_by(`Sales Channel`) %>%
  summarise(
    unique_dates = n(),
    start_date = min(min_soh_orderdate),
    end_date = max(max_soh_orderdate),
    total_sales = sum(total_soh_dollars)
  ) %>%
  gt()
```

As we will see later on, the Sales Rep data doesn't match the Online data.  The Online data includes 2 months that are not included in the main sales channel.

### Monthly variation compared to a trend line

Jumping to the trend line comparison, we see that the variation 

```{r fig.cap='SO, SO Dollars, and Average SO Dollars-b ',fig.width=16}

# sp_print_df(monthly_sales_w_channel)

ggplot(
  data = monthly_sales_w_channel,
  aes(
    x = orderdate, y = total_soh_dollars
  )
) +
  geom_line() +
  geom_smooth(se = FALSE) +
  facet_wrap("onlineorderflag") +
  scale_y_continuous(labels = dollar) +
  scale_x_date(date_breaks = "year", date_labels = "%Y", date_minor_breaks = "3 months") +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Sales by Month by Year\n",
      "With Number of Sales Orders\nAnd Average SO $ Amount"
    ),
    x = paste("Month - between ", min_soh_dt, " - ", max_soh_dt),
    y = "Sales Dollars"
  )
```

The monthly variation is happening on the Sales Rep side.

### Compare monthly lagged data by order type

First consider month-to-month change.
```{r}
monthly_sales_w_channel_lagged_by_month <- monthly_sales_w_channel %>%
  group_by(onlineorderflag) %>%
  mutate(
    pct_yearly_soh_dollar_change =
      total_soh_dollars / (lag(total_soh_dollars, 1)) * 100,
    pct_yearly_soh_count_change =
      soh_count / (lag(soh_count, 1)) * 100
  )

ggplot(monthly_sales_w_channel_lagged_by_month, aes(x = orderdate, y = pct_yearly_soh_dollar_change)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y", date_minor_breaks = "3 months") +
  facet_wrap("onlineorderflag") +
  geom_line() +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Monthly Percent Sales Change \n",
      "Comparing Online to Sales Rep Sales"
    ),
    x = paste("Month - between ", min_soh_dt, " - ", max_soh_dt),
    y = "% Dollar Change"
  )
```

For Sales Reps it looks like the variation is in the number of orders, not just dollars.
```{r}
ggplot(monthly_sales_w_channel_lagged_by_month, aes(x = orderdate, y = pct_yearly_soh_count_change)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y", date_minor_breaks = "3 months") +
  facet_wrap("onlineorderflag") +
  geom_line() +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Monthly Order Volume Change \n",
      "Comparing Online to Sales Rep Sales\n",
      min_soh_dt, " - ", max_soh_dt
    ),
    x = "Month",
    y = "Change number of orders"
  )
```


Let's examine whether there is a large year-to-year change.
```{r}
monthly_sales_w_channel_lagged_by_year <- monthly_sales_w_channel %>%
  group_by(onlineorderflag) %>%
  mutate(
    pct_yearly_soh_dollar_change =
      total_soh_dollars / (lag(total_soh_dollars, 12)) * 100,
    pct_yearly_soh_count_change =
      soh_count / (lag(soh_count, 12)) * 100
  )

ggplot(monthly_sales_w_channel_lagged_by_year, aes(x = orderdate, y = pct_yearly_soh_dollar_change)) +
  scale_x_date(date_breaks = "year", date_labels = "%Y", date_minor_breaks = "3 months") +
  scale_y_continuous(limits = c(-10, 300)) +
  facet_wrap("onlineorderflag") +
  geom_line() +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Year-on-Year Total Monthly Sales Change \n",
      "Comparing Online to Sales Rep Sales\n",
      min_soh_dt, " - ", max_soh_dt
    ),
    x = paste("Month - between ", min_soh_dt, " - ", max_soh_dt),
    y = "% Dollar Change"
  )
```

That's much smaller than the month-to-month change.

Comparing the number of sales orders year over year by month for 2013 and 2012, one can see that the 2013 sales are between 1.2 and 1.8 times larger than the corresponding month of 2012 from January through June.  In July the 2013 sales are 5 to 6 times the 2012 sales orders.

This trend continues into 2014 before the number of sales plummet to just 1.3 time in June.

We suspect that the business has changed a lot with the adventn of online orders.

## Detect and diagnose the day of the month problem

Looking at the raw data leads us to suspct that there is a problem with the dates on which Sales Rep orders are entered.

### Sales Rep Orderdate Distribution

Look at the dates when sales are entered for sales by Sales Reps.  The following query merits some discussion.

```{r}
sales_rep_day_of_month_sales <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  filter(onlineorderflag == FALSE) %>% # Drop online orders
  select(orderdate, subtotal) %>%
  mutate(
    year = year(orderdate),
    month = month(orderdate),
    day = day(orderdate)
  ) %>%
  count(year, month, day, name = "orders") %>%
  group_by(year, month) %>%
  summarize(
    days_with_orders = n(),
    total_orders = sum(orders, na.rm = TRUE),
    min_day = min(day, na.rm = FALSE)
  ) %>%
  show_query() %>%
  collect() %>%
  mutate(
    days_with_orders = as.numeric(days_with_orders),
    order_month = as.Date(paste0(year, "-", month, "-01")),
    min_day_factor = if_else(min_day < 2, "Month start", "Month end")
  ) %>%
  complete(order_month = seq(min(order_month), max(order_month), by = "month")) %>%
  mutate(days_with_orders = replace_na(days_with_orders, 0)) %>%
  ungroup()
```


```{r}
sales_rep_day_of_month_sales %>%
  ggplot(aes(order_month, days_with_orders, fill = min_day_factor)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "How many days had Sales Rep orders posted",
    subtitle = "At the beginning or end of the month?",
    fill = "Day Sales were posted",
    y = "Number of days with transactions",
    x = "Date"
  )
```

Suspicious months are those where sales were recorded on more than one day or there were no sales recorded in the month at all.
```{r}
suspicious_months <- sales_rep_day_of_month_sales %>%
  filter(days_with_orders == 0 | days_with_orders > 1) %>%
  arrange(order_month) %>%
  select(order_month) %>%
  unique()
```

Here are the `r nrow(suspicious_months)` suspicious months:
```{r}
suspicious_months
```


```{r}
months_to_inspect <- tibble(target_month = suspicious_months) %>%
  mutate(
    current_month = target_month$order_month,
    next_month = current_month %m+% months(1),
    last_month = current_month %m-% months(1)
  ) %>%
  select(current_month, next_month, last_month) %>%
  pivot_longer(cols = tidyselect::peek_vars()) %>%
  select(value) %>%
  distinct()
```
We have `r nrow(months_to_inspect)` months when we add the month before and the month afterwards -- and eliminate duplicates.

```{r}
monthly_sales_w_channel_to_inspect <- monthly_sales_w_channel %>%
  filter(onlineorderflag == "Sales Rep") %>%
  mutate(order_month = round_date(orderdate, "month")) %>%
  right_join(months_to_inspect, by = c("order_month" = "value")) %>%
  select(-onlineorderflag, -min_soh_orderdate, -max_soh_orderdate) %>%
  arrange(desc(orderdate))

monthly_sales_w_channel_to_inspect
```
That is unexpected.  A couple of  things immediately jump out from the first page of data:

*  July, September, and November are missing for 2011. 
*  Most of the sales reps' orders are entered on a single day of the month, unique days = 1. It is possible that these are monthly recurring orders that get released on a given day of the month.  If that is the case, what are the sales reps doing the rest of the month?
*  The lines with multiple days, unique_days > 1, have a noticeable higher number of orders, so_cnt, and associated so dollars.

The plot clearly shows that two months with multiple sales rep order days for 2011, (1108 and 1110), one for 2012, (1201), and two in 2014, (1401 and 1403).  The 1403 is the only three day sales rep order month.

In the next code block, we flesh out the dates associatd with the sales reps' orders.  Since 4 out of the 5 months with multiple order days only have two dates, the code block captures them with a min/max orderdate.

## Correcting the order date for Sales Reps

```{r}
monthly_sales_rep_adjusted <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal, onlineorderflag) %>%
  mutate(
    orderdate = as.Date(orderdate),
    day = day(orderdate)
  ) %>%
  show_query() %>%
  collect() # From here on we're in R
```

```{r}
monthly_sales_rep_adjusted %>%
  filter(day == 1 & onlineorderflag == FALSE) %>%
  count(orderdate) %>%
  as.data.frame()
```



```{r}
dbGetQuery(
  con,
  "
with udays as (
SELECT to_char(orderdate,'YYMM') yymm
     ,EXTRACT(YEAR FROM soh.orderdate) yr
     , EXTRACT(MONTH FROM soh.orderdate) mo 
     , COUNT(DISTINCT soh.orderdate) *1.0 unique_days
     , COUNT(*) so_cnt
     , sum(subtotal) so_dollars
  FROM sales.salesorderheader soh
where not onlineorderflag
group by to_char(orderdate,'YYMM') 
     , EXTRACT(MONTH FROM orderdate) 
     , EXTRACT(YEAR FROM orderdate)
ORDER BY to_char(orderdate,'YYMM')
)
select soh.orderdate,count(*) from udays 
join sales.salesorderheader soh on to_char(soh.orderdate,'YYMM')  = udays.yymm
where unique_days > 1
  and not onlineorderflag
group by soh.orderdate
having count(*) > 1
order by orderdate
"
)
```

### Define a date correction function in R

```{r}
monthly_sales_rep_adjusted <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal, onlineorderflag) %>%
  mutate(
    orderdate = as.Date(orderdate),
    day = day(orderdate)
  ) %>%
  show_query() %>%
  collect() %>%

  # From here on we're in R
  # Writing the mutate statement in a generic form, so it applies only
  #   to Sales Rep orders

  mutate(
    adjusted_orderdate = case_when(
      onlineorderflag == FALSE & day == 1L ~ orderdate - 1,
      TRUE ~ orderdate
    )
  ) %>%
  filter(onlineorderflag == FALSE) %>%
  group_by(adjusted_orderdate) %>%
  summarize(
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  ) %>%
  ungroup()
```

### Define and store a Postgres function to correct the date

```{r}
dbExecute(
  con,
  "CREATE OR REPLACE FUNCTION so_adj_date(so_date timestamp, ONLINE_ORDER boolean) RETURNS timestamp AS $$
     BEGIN
        IF (ONLINE_ORDER) THEN
            RETURN (SELECT so_date);
        ELSE
            RETURN(SELECT CASE WHEN EXTRACT(DAY FROM so_date) = 1
                               THEN  so_date - '1 day'::interval
                               ELSE  so_date
                          END
                  );
        END IF;
 END; $$
LANGUAGE PLPGSQL;
"
)
```

### Use the Postgres function

If you can do the heavy lifting on the database side, that's good.  R can do it, but it's best for finding the issues.

```{r}
monthly_sales_rep_adjusted_with_psql_function <- tbl(con, in_schema("sales", "salesorderheader")) %>%
  select(orderdate, subtotal, onlineorderflag) %>%
  mutate(
    orderdate = as.Date(orderdate),
    day = day(orderdate)
  ) %>%
  mutate(adjusted_orderdate = as.Date(so_adj_date(orderdate, onlineorderflag))) %>%
  filter(onlineorderflag == FALSE) %>%
  group_by(adjusted_orderdate) %>%
  summarize(
    total_soh_dollars = round(sum(subtotal, na.rm = TRUE), 2),
    avg_total_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2),
    soh_count = n()
  ) %>%
  show_query() %>%
  collect() %>%
  ungroup()
```

There's one minor difference between the two:
```{r}
all_equal(monthly_sales_rep_adjusted, monthly_sales_rep_adjusted_with_psql_function)
```



```{r}
monthly_sales_rep_adjusted %>% 
  mutate(day_of_month = day(adjusted_orderdate)) %>% 
ggplot( aes(x = day_of_month, y = soh_count)) +
  geom_col() +
  scale_x_continuous(limits = c(1, 32)) +
  labs(
    title = paste(
      "Transactions Entered by Day of Month \n",
      "Comparing Online to Sales Rep Sales\n",
      min_soh_dt, " - ", max_soh_dt
    ),
    x = "Day of the Month",
    y = "Recorded Sales"
  ) +
  theme(plot.title = element_text(hjust = .5)) # Center ggplot title
```

### Monthly Sales by Order Type with corrected dates -- relative to a trend line


```{r}

monthly_sales_rep_as_is <- monthly_sales_w_channel %>% 
  filter(onlineorderflag == "Sales Rep")
  

ggplot(
  data = monthly_sales_rep_adjusted,
  aes(x = adjusted_orderdate, y = soh_count)
) +
  geom_line(alpha = .5) +
  geom_smooth(se = FALSE) +
  geom_smooth(data = monthly_sales_rep_as_is, aes(
    orderdate, soh_count
  ), color = "red", alpha = .5,
  se = FALSE) +
  theme(plot.title = element_text(hjust = .5)) + # Center ggplot title
  labs(
    title = paste(
      "Number of Sales per month using corrected dates\n",
      "Counting Sales Order Header records"
    ),
    x = paste("Monthly - between ", min_soh_dt, " - ", max_soh_dt),
    y = "Number of Sales Recorded"
  )
```


## Disconnect from the database and stop Docker

```{r}
dbDisconnect(con)
sp_docker_stop("adventureworks")
```
