[
["chapter-exploring-a-single-table.html", "Chapter 8 Exploring a Single Table (asking Business Questions) 8.1 Setup our standard working environment 8.2 Is this company making any money? 8.3 What happened in July 2013? 8.4 Monthly Sales Rep Performance Analysis 8.5 Adventure Works Monthly Sales 8.6 Close and clean up", " Chapter 8 Exploring a Single Table (asking Business Questions) This chapter demonstrates how to: Dig into a single Adventureworks table containing sales data Investigate the data from a business value perspective This chapter explores one table, illustrating the kind of detective work that’s often involved in understand a single table. We’ll investigate the salesorderheader table in the sales schema in this example. 8.1 Setup our standard working environment Use these libraries: library(tidyverse) library(DBI) library(RPostgres) library(glue) require(knitr) library(dbplyr) library(sqlpetr) library(bookdown) library(here) library(lubridate) library(scales) # ggplot xy scales theme_set(theme_light()) Connect to adventureworks: sp_docker_start(&quot;adventureworks&quot;) Sys.sleep(sleep_default) con &lt;- sp_get_postgres_connection( host = &quot;localhost&quot;, port = 5432, user = &quot;postgres&quot;, password = &quot;postgres&quot;, dbname = &quot;adventureworks&quot;, seconds_to_test = sleep_default, connection_tab = TRUE ) The previous chapter has demonstrated some of the automated techniques for showing what’s in the table using specific functions and packages. Now we demonstrate a step-by-step process of making sense of what’s in a table from a business perspective. 8.2 Is this company making any money? We begin with counts and totals at different levels of detail. On an annual basis, are sales dollars trending up, down or flat? You will find that many columns have the same name in an enterprise database. For example, in the adventureworks database, many tables have columns named rowguid and modifieddate. Renaming columns (both retrieved from the database and calculated) carefully will pay off as our queries become more complex. Using soh to tag statistics that are derived from the salesorderheader table is one example of careful naming. A naming convention that helps you figure out the original source of a column is a matter of applying some logic to how things are named; you, future you, and your collaborators will appreciate it although different naming conventions are completely valid. In the following example soh appears in different positions in the column name but it is easy to guess that the data comes from salesorderheader. 8.2.1 Annual sales annual_sales &lt;- tbl(con, in_schema(&quot;sales&quot;, &quot;salesorderheader&quot;)) %&gt;% mutate(year = substr(as.character(orderdate), 1, 4)) %&gt;% group_by(year) %&gt;% summarize( min_soh_orderdate = min(orderdate, na.rm = TRUE), max_soh_orderdate = max(orderdate, na.rm = TRUE), soh_dollars = round(sum(subtotal, na.rm = TRUE), 2), avg_soh_dollars = round(mean(subtotal, na.rm = TRUE),2), soh_count = n() ) %&gt;% arrange(year) %&gt;% select(year, min_soh_orderdate, max_soh_orderdate, soh_dollars, avg_soh_dollars, soh_count) %&gt;% collect() annual_sales ## # A tibble: 4 x 6 ## year min_soh_orderdate max_soh_orderdate soh_dollars avg_soh_dollars ## &lt;chr&gt; &lt;dttm&gt; &lt;dttm&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 2011 2011-05-31 00:00:00 2011-12-31 00:00:00 12641672. 7867. ## 2 2012 2012-01-01 00:00:00 2012-12-31 00:00:00 33524301. 8563. ## 3 2013 2013-01-01 00:00:00 2013-12-31 00:00:00 43622479. 3076. ## 4 2014 2014-01-01 00:00:00 2014-06-30 00:00:00 20057929. 1705. ## # … with 1 more variable: soh_count &lt;int64&gt; Both 2011 and 2014 are shorter time spans than the other two years, making comparison across the years more difficult. min_soh_dt &lt;- min(annual_sales$min_soh_orderdate) max_soh_dt &lt;- max(annual_sales$max_soh_orderdate) ggplot(data = annual_sales, aes(x = year, y = soh_dollars)) + geom_col() + xlab(&quot;Year&quot;) + ylab(&quot;Sales $&quot;) + scale_y_continuous(labels = scales::dollar_format()) + ggtitle(paste(&quot;Adventure Works Sales Dollars by Year\\n &quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) From 2011 through 2013, sales are trending up and the growth between years is slowing down. 2014 sales dollars look a little behind 2013. Are sales dollars for 2014 really down or are sales dollars seasonal? To see if the sales dollars are seasonal, we will drill in and look at the monthly sales. How are the sales dollars related to the number of orders and what is the average order amount? In the next plot, the title is centered, the y-axis is re-scaled, and number of orders and average order dollar amount is added to the top of each bar. The following 3 plots show how odd the sales data is: Look at average dollars per sale sale by year: ggplot(data = annual_sales, aes(x = year, y = avg_soh_dollars)) + geom_col() + xlab(&quot;Year&quot;) + ylab(&quot;Average sale amount&quot;) + scale_y_continuous(labels = scales::dollar_format()) + ggtitle(paste(&quot;Average Dollars per Sale\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) Look at number of orders per year: ggplot(data = annual_sales, aes(x = year, y = as.numeric(soh_count))) + geom_col() + xlab(&quot;Year&quot;) + ylab(&quot;Total number of orders&quot;) + ggtitle(paste(&quot;Number of Orders per Year\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) Look at number of orders by the the average sales per order for the four years: annual_sales %&gt;% arrange(min_soh_orderdate) %&gt;% ggplot(aes(x = avg_soh_dollars, y = as.numeric(soh_count))) + geom_point() + geom_text(aes(label = year, hjust = .5, vjust = 0)) + geom_path() + xlab(&quot;Average dollars per order&quot;) + ylab(&quot;Total number of orders&quot;) + scale_y_continuous(labels = scales::dollar_format()) + scale_x_continuous(labels = scales::dollar_format()) + ggtitle(paste(&quot;Number of Orders by Average Order Amount\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) From 2012 to 2013 the average dollars per order dropped from more than $8,500 to nearly $3,000 while the total number of order shot up from less than 4,000 to more than 14,000. Why are the number of orders increasing, but the average order dollar amount dropping? We need to drill down to look at monthly sales, adapting the first query to group by month and year. 8.2.2 Monthly Sales The next code block drills down from annual sales dollars to monthly sales dollars. We adopt a more R-like strategy; rather than yr as a character variable, we just download the orderdate. R handles the coversion from the postgres date-time to an R date-time. We then convert it to a simple date with a lubridate function. monthly_sales &lt;- tbl(con, in_schema(&quot;sales&quot;, &quot;salesorderheader&quot;)) %&gt;% select(orderdate, subtotal) %&gt;% collect() %&gt;% mutate(orderdate = date(orderdate), orderdate = round_date(orderdate, &quot;month&quot;)) %&gt;% group_by(orderdate) %&gt;% summarize( min_soh_orderdate = min(orderdate, na.rm = TRUE), max_soh_orderdate = max(orderdate, na.rm = TRUE), soh_dollars = round(sum(subtotal, na.rm = TRUE), 2), avg_soh_dollars = round(mean(subtotal, na.rm = TRUE), 2), soh_count = n() ) sp_print_df(head(monthly_sales)) min_soh_dt &lt;- min(monthly_sales$min_soh_orderdate) max_soh_dt &lt;- max(monthly_sales$max_soh_orderdate) ggplot(data = monthly_sales, aes(x = orderdate, y = soh_dollars)) + geom_col() + xlab(&quot;Month&quot;) + ylab(&quot;Sales Dollars&quot;) + scale_y_continuous(labels = dollar) + theme(plot.title = element_text(hjust = 0.5)) + # Center the title ggtitle(paste(&quot;Sales by Month\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) min_soh_dt &lt;- min(monthly_sales$min_soh_orderdate) max_soh_dt &lt;- max(monthly_sales$max_soh_orderdate) start_year &lt;- monthly_sales %&gt;% mutate(yr = year(orderdate)) %&gt;% group_by(yr) %&gt;% summarize(soh_dollars = sum(soh_dollars), soh_count = sum(soh_count), n_months = n(), avg_dollars = soh_dollars / n_months, avg_count = soh_count / n_months) %&gt;% filter(yr == min(yr)) start_year ## # A tibble: 1 x 6 ## yr soh_dollars soh_count n_months avg_dollars avg_count ## &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; ## 1 2011 12354206. 1513 7 1764887. 216. normalized_monthly_sales &lt;- monthly_sales %&gt;% mutate(dollars = (100 * soh_dollars) / start_year$avg_dollars, number_of_orders = (100 * soh_count) / start_year$avg_count) %&gt;% ungroup() normalized_monthly_sales &lt;- normalized_monthly_sales %&gt;% select(orderdate, dollars, number_of_orders) %&gt;% pivot_longer(-orderdate, names_to = &quot;relative_to_2011_average&quot;, values_to = &quot;amount&quot; ) normalized_monthly_sales %&gt;% ggplot(aes(orderdate, amount, color = relative_to_2011_average)) + geom_line() + geom_hline(yintercept = 100) + xlab(&quot;Date&quot;) + ylab(&quot;&quot;) + scale_x_date(date_labels = &quot;%Y-%m&quot;, date_breaks = &quot;6 months&quot;) + ggtitle(paste(&quot;Adventureworks Normalized Monthly Sales\\nNumber of Sales Orders and Dollar Totals\\n&quot;, min_soh_dt, &quot; to &quot;, max_soh_dt)) 8.2.3 Annual sales by sale type (online sales?) We suspect that the business has changed a lot with the adventn of online orders. annual_sales &lt;- tbl(con, in_schema(&quot;sales&quot;, &quot;salesorderheader&quot;)) %&gt;% select(orderdate, subtotal, onlineorderflag) %&gt;% collect() %&gt;% mutate(orderdate = date(orderdate), orderdate = round_date(orderdate, &quot;year&quot;), onlineorderflag = if_else(onlineorderflag == FALSE, &quot;Sales Rep&quot;, &quot;Online&quot;), onlineorderflag = as.factor(onlineorderflag)) %&gt;% group_by(orderdate, onlineorderflag) %&gt;% summarize( min_soh_orderdate = min(orderdate, na.rm = TRUE), max_soh_orderdate = max(orderdate, na.rm = TRUE), soh_dollars = round(sum(subtotal, na.rm = TRUE), 2), avg_soh_dollars = round(mean(subtotal, na.rm = TRUE),2), soh_count = n() ) %&gt;% select(orderdate, onlineorderflag, min_soh_orderdate, max_soh_orderdate, soh_dollars, avg_soh_dollars, soh_count) annual_sales %&gt;% mutate(onlineorderflag = if_else(onlineorderflag == FALSE, &quot;Sales Rep&quot;, &quot;Online&quot;), onlineorderflag = as.factor(onlineorderflag)) ## # A tibble: 8 x 7 ## # Groups: orderdate [4] ## orderdate onlineorderflag min_soh_orderda… max_soh_orderda… soh_dollars ## &lt;date&gt; &lt;fct&gt; &lt;date&gt; &lt;date&gt; &lt;dbl&gt; ## 1 2011-01-01 Online 2011-01-01 2011-01-01 502014. ## 2 2011-01-01 Online 2011-01-01 2011-01-01 2027737. ## 3 2012-01-01 Online 2012-01-01 2012-01-01 7100344. ## 4 2012-01-01 Online 2012-01-01 2012-01-01 20255585. ## 5 2013-01-01 Online 2013-01-01 2013-01-01 6193477. ## 6 2013-01-01 Online 2013-01-01 2013-01-01 28815142. ## 7 2014-01-01 Online 2014-01-01 2014-01-01 15562842. ## 8 2014-01-01 Online 2014-01-01 2014-01-01 29389240. ## # … with 2 more variables: avg_soh_dollars &lt;dbl&gt;, soh_count &lt;int&gt; # onlineorderflag = as.factor(onlineorderflag, levels(FALSE = &quot;Sales Rep&quot;, TRUE = &quot;Online&quot;)) Both 2011 and 2014 are shorter time spans than the other two years, making comparison across the years more difficult. min_soh_dt &lt;- min(annual_sales$min_soh_orderdate) max_soh_dt &lt;- max(annual_sales$max_soh_orderdate) ggplot(data = annual_sales, aes(x = orderdate, y = soh_dollars)) + geom_col() + xlab(&quot;Year&quot;) + ylab(&quot;Sales $&quot;) + scale_y_continuous(labels = scales::dollar_format()) + facet_wrap(&quot;onlineorderflag&quot;) + ggtitle(paste(&quot;Adventure Works Sales Dollars by Year\\n &quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) From 2011 through 2013, sales are trending up and the growth between years is slowing down. 2014 sales dollars look a little behind 2013. Are sales dollars for 2014 really down or are sales dollars seasonal? To see if the sales dollars are seasonal, we will drill in and look at the monthly sales. How are the sales dollars related to the number of orders and what is the average order amount? In the next plot, the title is centered, the y-axis is re-scaled, and number of orders and average order dollar amount is added to the top of each bar. The following 3 plots show how odd the sales data is: Look at average dollars per sale sale by year: ggplot(data = annual_sales, aes(x = orderdate, y = avg_soh_dollars)) + geom_col() + xlab(&quot;Year&quot;) + ylab(&quot;Average sale amount&quot;) + facet_wrap(&quot;onlineorderflag&quot;) + scale_y_continuous(labels = scales::dollar_format()) + ggtitle(paste(&quot;Average Dollars per Sale\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) Look at number of orders per year: ggplot(data = annual_sales, aes(x = orderdate, y = as.numeric(soh_count))) + geom_col() + xlab(&quot;Year&quot;) + facet_wrap(&quot;onlineorderflag&quot;) + ylab(&quot;Total number of orders&quot;) + ggtitle(paste(&quot;Number of Orders per Year\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) Look at number of orders by the the average sales per order for the four years: annual_sales %&gt;% arrange(orderdate) %&gt;% ggplot(aes(x = avg_soh_dollars, y = as.numeric(soh_count))) + geom_point() + geom_text(aes(label = orderdate, hjust = .5, vjust = 0)) + geom_path() + xlab(&quot;Average dollars per order&quot;) + ylab(&quot;Total number of orders&quot;) + facet_wrap(&quot;onlineorderflag&quot;, scales = &quot;free&quot;) + scale_y_continuous(labels = scales::dollar_format()) + scale_x_continuous(labels = scales::dollar_format()) + ggtitle(paste(&quot;Number of Orders by Average Order Amount\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) From 2012 to 2013 the average dollars per order dropped from more than $8,500 to nearly $3,000 while the total number of order shot up from less than 4,000 to more than 14,000. Why are the number of orders increasing, but the average order dollar amount dropping? We need to drill down to look at monthly sales, adapting the first query to group by month and year. # sp_print_df(monthly_sales) ggplot( data = monthly_sales, aes( x = orderdate, y = soh_dollars # x = orderdate, y = soh_dollars, color = as.factor(yr), # group = as.factor(yr) ) ) + # Removes msg: Each group consists of only one observation. Do you need to adjust the group aesthetic? geom_line() + geom_point() + xlab(&quot;Month&quot;) + ylab(&quot;Sales Dollars&quot;) + scale_y_continuous(labels = dollar) + # geom_text(aes(label = paste(soh_count, &quot; # &quot;, avg_soh_dollars)), # size = 2.5, # color = &quot;black&quot;, # vjust = 1.5, # position = position_dodge(.5) # ) + # orders =&gt; avg so $ amt theme(plot.title = element_text(hjust = .5)) + # Center ggplot title ggtitle(paste(&quot;Sales by Month by Year\\nWith Number of Sales Orders\\nAnd Average SO $ Amount\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) Figure 8.1: SO, SO Dollars, and Average SO Dollars A couple of things jump out from the graph. 2012 and 2013 have similar sales dollar plots and peak every three months. This may reflect the closing as many sales orders as possible to make the quarterly sales numbers look good. 2011 has more variation than 2012 and 2013 and peaks every two months. 2014 has the most variation and also peaks every two months. Both the number of sales, 939, and the average sales order size, $52.19 plummet in June 2014. # sp_print_df(monthly_sales) ggplot( data = monthly_sales, aes( x = orderdate, y = soh_dollars) # , color = as.factor(yr), # group = as.factor(yr) # ) ) + geom_line() + geom_smooth(se = FALSE) + xlab(&quot;Month&quot;) + ylab(&quot;Sales Dollars&quot;) + scale_y_continuous(labels = dollar) + scale_x_date(date_breaks = &quot;year&quot;, date_labels = &quot;%Y&quot;, date_minor_breaks = &quot;3 months&quot;) + theme(plot.title = element_text(hjust = .5)) + # Center ggplot title ggtitle(paste(&quot;Sales by Month by Year\\nWith Number of Sales Orders\\nAnd Average SO $ Amount\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) ## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39; Figure 8.2: SO, SO Dollars, and Average SO Dollars-b A couple of things jump out from the graph. 2012 and 2013 have similar sales dollar plots and peak every three months. This may reflect the closing as many sales orders as possible to make the quarterly sales numbers look good. 2011 has more variation than 2012 and 2013 and peaks every two months. 2014 has the most variation and also peaks every two months. Both the number of sales, 939, and the average sales order size, $52.19 plummet in June 2014. lagged &lt;- monthly_sales %&gt;% mutate(pct_yearly_soh_dollar_change = soh_dollars / (lag(soh_dollars, 12)) * 100, pct_yearly_soh_count_change = soh_count / (lag(soh_count, 12)) * 100) ggplot(lagged, aes(x = orderdate, y = pct_yearly_soh_dollar_change)) + geom_line() ## Warning: Removed 12 rows containing missing values (geom_path). ggplot(lagged, aes(x = orderdate, y = pct_yearly_soh_count_change)) + geom_line() ## Warning: Removed 12 rows containing missing values (geom_path). Comparing the number of sales orders year over year by month for 2013 and 2012, one can see that the 2013 sales are between 1.2 and 1.8 times larger than the corresponding month of 2012 from January through June. In July the 2013 sales are 5 to 6 times the 2012 sales orders. This trend continues into 2014 before the number of sales plummet to just 1.3 time in June. We suspect that the business has changed a lot with the adventn of online orders. monthly_sales &lt;- tbl(con, in_schema(&quot;sales&quot;, &quot;salesorderheader&quot;)) %&gt;% select(orderdate, subtotal, onlineorderflag) %&gt;% collect() %&gt;% mutate(orderdate = date(orderdate), orderdate = round_date(orderdate, &quot;month&quot;), onlineorderflag = if_else(onlineorderflag == FALSE, &quot;Sales Rep&quot;, &quot;Online&quot;), onlineorderflag = as.factor(onlineorderflag)) %&gt;% group_by(onlineorderflag, orderdate) %&gt;% summarize( min_soh_orderdate = min(orderdate, na.rm = TRUE), max_soh_orderdate = max(orderdate, na.rm = TRUE), soh_dollars = round(sum(subtotal, na.rm = TRUE), 2), avg_soh_dollars = round(mean(subtotal, na.rm = TRUE),2), soh_count = n() ) %&gt;% select(orderdate, onlineorderflag, min_soh_orderdate, max_soh_orderdate, soh_dollars, avg_soh_dollars, soh_count) lagged &lt;- monthly_sales %&gt;% group_by(onlineorderflag) %&gt;% mutate(pct_yearly_soh_dollar_change = soh_dollars / (lag(soh_dollars, 12)) * 100, pct_yearly_soh_count_change = soh_count / (lag(soh_count, 12)) * 100) ggplot(lagged, aes(x = orderdate, y = pct_yearly_soh_dollar_change, color = onlineorderflag)) + geom_line() ## Warning: Removed 24 rows containing missing values (geom_path). ggplot(lagged, aes(x = orderdate, y = pct_yearly_soh_count_change, color = onlineorderflag)) + geom_line() ## Warning: Removed 24 rows containing missing values (geom_path). 8.3 What happened in July 2013? mo_onl_pct &lt;- dbGetQuery( con, &quot; SELECT * ,round(orders/mo_orders * 100.0,2) mo_pct ,round(sales_dollars/mo_sales * 100.0,2) mo_dlr_pct FROM (SELECT EXTRACT(MONTH FROM orderdate) mo, EXTRACT(YEAR FROM orderdate) yr , min(orderdate)::DATE min_soh_orderdate, max(orderdate)::DATE max_soh_orderdate , round(sum(subtotal), 2) sales_dollars , round(sum(sum(subtotal)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)),2) mo_sales , count(*) * 1.0 orders , sum(count(*)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)) mo_orders , case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end sales_type FROM sales.salesorderheader sh GROUP BY EXTRACT(MONTH FROM orderdate), EXTRACT(YEAR FROM orderdate), case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end ) as src ORDER BY mo, yr, sales_type &quot; ) sp_print_df(head(mo_onl_pct)) min_soh_dt &lt;- min(monthly_sales$min_soh_orderdate) max_soh_dt &lt;- max(monthly_sales$max_soh_orderdate) mo_onl_pct$mo &lt;- as.factor(mo_onl_pct$mo) mo_onl_pct$yr &lt;- as.factor(mo_onl_pct$yr) mo_onl_pct$sales_type &lt;- as.factor(mo_onl_pct$sales_type) mo_2011 &lt;- mo_onl_pct %&gt;% filter(yr == 2011) mo_2012 &lt;- mo_onl_pct %&gt;% filter(yr == 2012) mo_2013 &lt;- mo_onl_pct %&gt;% filter(yr == 2013) mo_2014 &lt;- mo_onl_pct %&gt;% filter(yr == 2014) ggplot(data = NULL) + # data=mo_2011 first results in the x axis months out of order. geom_line(data = mo_2012, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2011, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2013, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2014, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_point(data = mo_2011, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2012, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2013, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2014, aes(x = mo, y = mo_pct, color = sales_type)) + geom_text( data = mo_2011, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.5, hjust = 0 ) + geom_text( data = mo_2012, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.5, hjust = 0 ) + geom_text( data = mo_2013, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.5, hjust = 0 ) + geom_text( data = mo_2014, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), color = &quot;lightblue&quot;, position = position_dodge(.3), size = 2.5, hjust = 0, vjust = 1.5 ) + xlab(&quot;Month&quot;) + ylab(&quot;% Online Sales\\nvs\\n%Rep Sales&quot;) + theme(plot.title = element_text(hjust = .50)) + ggtitle(paste( &quot;Sales by Month\\n&quot;, &quot;Online Orders Versus Rep Orders\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt, &quot; &quot;, &quot;Each Point shows Number of Orders: $ Amount: % of Total $ For the Month&quot; )) The sales rep orders brought in over half the monthly sales dollars for every month except three, February, April, and June of 2014. The monthly sales rep orders for those months are 3, 2, and 0 respectively. 8.4 Monthly Sales Rep Performance Analysis mo_soh_sreps &lt;- dbGetQuery( con, &quot; SELECT * ,round(orders/mo_orders * 100.0,2) mo_pct ,round(sales_dollars/mo_sales * 100.0,2) mo_dlr_pct FROM (SELECT EXTRACT(MONTH FROM orderdate) mo, EXTRACT(YEAR FROM orderdate) yr , min(orderdate)::DATE min_soh_orderdate, max(orderdate)::DATE max_soh_orderdate , round(sum(subtotal), 2) sales_dollars , round(sum(sum(subtotal)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)),2) mo_sales , count(*) * 1.0 orders , sum(count(*)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)) mo_orders , case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end sales_type FROM sales.salesorderheader sh INNER JOIN sales.salesorderdetail sd ON sh.salesorderid = sd.salesorderid WHERE not sh.onlineorderflag GROUP BY EXTRACT(MONTH FROM orderdate), EXTRACT(YEAR FROM orderdate), case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end ) as src ORDER BY mo, yr, sales_type &quot; ) sp_print_df(head(mo_soh_sreps)) monthly_sales_online &lt;- dbGetQuery( con, &quot; SELECT EXTRACT(MONTH FROM orderdate) mo, EXTRACT(YEAR FROM orderdate) yr , min(orderdate)::DATE min_soh_orderdate, max(orderdate)::DATE max_soh_orderdate , so.category , round(sum(subtotal), 2) sales_dollars , count(*) * 1.0 orders FROM sales.salesorderheader sh JOIN sales.salesorderdetail sd ON SH.salesorderid = sd.salesorderid JOIN sales.specialoffer so ON Sd.specialofferid = so.specialofferid GROUP BY EXTRACT(MONTH FROM orderdate), EXTRACT(YEAR FROM orderdate), so.category ORDER BY mo, yr &quot; ) sp_print_df(head(monthly_sales_online)) Figure 8.3: caption goes here ggplot(data = monthly_sales_online, aes(x = factor(mo), y = sales_dollars, fill = factor(yr))) + geom_col(position = &quot;dodge&quot;, color = &quot;black&quot;) + # unstack columns and outline in black xlab(&quot;Month&quot;) + ylab(&quot;Sales Dollars&quot;) + scale_y_continuous(labels = dollar) + geom_text(aes(label = category), size = 2.5 # ,color = &#39;black&#39; , vjust = 1.5, position = position_dodge(.9) ) + # orders =&gt; avg so $ amt theme(plot.title = element_text(hjust = .50)) + # Center ggplot title ggtitle(paste(&quot;Sales by Month\\nBy Online Flag&quot;)) Figure 8.3: caption goes here monthly_sales_onl_pct &lt;- dbGetQuery( con, &quot; select EXTRACT(MONTH FROM orderdate) mo ,EXTRACT(YEAR FROM orderdate) yr ,sum(ORDERQTY) ,sum(case when salespersonid is null and onlineorderflag then 1 else 0 end) onl ,sum(case when salespersonid is not null and not onlineorderflag then 1 else 0 end) sp ,round(sum(case when onlineorderflag then 1 else 0 end )*1.0/count(*) * 100.0,2) onl_pct ,round(sum(case when not onlineorderflag then 1 else 0 end )*1.0/count(*) * 100.0,2) sp_pct ,onlineorderflag ,count(*) FROM sales.salesorderheader sh INNER JOIN sales.salesorderdetail sd ON sh.salesorderid = sd.salesorderid INNER JOIN production.product p ON sd.productid = p.productid INNER JOIN sales.specialoffer so ON sd.specialofferid = so.specialofferid LEFT OUTER JOIN sales.specialofferproduct sop ON sd.specialofferid = sop.specialofferid and sd.productid = sop.productid WHERE sop.productid is not null group by EXTRACT(MONTH FROM orderdate) ,EXTRACT(YEAR FROM orderdate) ,onlineorderflag order by mo,yr &quot; ) sp_print_df(head(monthly_sales_onl_pct)) mo_onl_pct &lt;- dbGetQuery( con, &quot; SELECT * ,round(orders/mo_orders * 100.0,2) mo_pct ,round(sales_dollars/mo_sales * 100.0,2) mo_dlr_pct FROM (SELECT EXTRACT(MONTH FROM orderdate) mo, EXTRACT(YEAR FROM orderdate) yr , min(orderdate)::DATE min_soh_orderdate, max(orderdate)::DATE max_soh_orderdate , round(sum(subtotal), 2) sales_dollars , round(sum(sum(subtotal)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)),2) mo_sales , count(*) * 1.0 orders , sum(count(*)) over (partition by EXTRACT(MONTH FROM orderdate),EXTRACT(YEAR FROM orderdate) order by EXTRACT(YEAR FROM orderdate)) mo_orders , case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end sales_type FROM sales.salesorderheader sh GROUP BY EXTRACT(MONTH FROM orderdate), EXTRACT(YEAR FROM orderdate), case when sh.onlineorderflag then &#39;online&#39; else &#39;sales rep&#39; end ) as src ORDER BY mo, yr, sales_type &quot; ) sp_print_df(head(mo_onl_pct)) min_soh_dt &lt;- min(monthly_sales$min_soh_orderdate) max_soh_dt &lt;- max(monthly_sales$max_soh_orderdate) mo_onl_pct$mo &lt;- as.factor(mo_onl_pct$mo) mo_onl_pct$yr &lt;- as.factor(mo_onl_pct$yr) mo_onl_pct$sales_type &lt;- as.factor(mo_onl_pct$sales_type) mo_2011 &lt;- mo_onl_pct %&gt;% filter(yr == 2011) mo_2012 &lt;- mo_onl_pct %&gt;% filter(yr == 2012) mo_2013 &lt;- mo_onl_pct %&gt;% filter(yr == 2013) mo_2014 &lt;- mo_onl_pct %&gt;% filter(yr == 2014) ggplot(data = NULL) + # data=mo_2011 first results in the x axis months out of order. geom_line(data = mo_2012, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2011, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2013, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_line(data = mo_2014, aes(x = mo, y = mo_pct, color = yr, group = sales_type)) + geom_point(data = mo_2011, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2012, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2013, aes(x = mo, y = mo_pct, color = sales_type)) + geom_point(data = mo_2014, aes(x = mo, y = mo_pct, color = sales_type)) + geom_text( data = mo_2011, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.25, hjust = 1.0 ) + geom_text( data = mo_2012, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.25, hjust = 1.0 ) + geom_text( data = mo_2013, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), position = position_dodge(.3), size = 2.25, hjust = 1.0 ) + geom_text( data = mo_2014, aes(x = mo, y = mo_pct, label = paste(orders, &quot;:$&quot;, sales_dollars, &quot;:&quot;, mo_dlr_pct, &quot;%&quot;)), color = &quot;lightblue&quot;, position = position_dodge(.3), size = 2.25, hjust = 1.0, vjust = 1.5 ) + xlab(&quot;Month&quot;) + ylab(&quot;% Online Sales\\nvs\\n%Rep Sales&quot;) + theme(plot.title = element_text(hjust = .50)) + ggtitle(paste( &quot;Sales by Month\\n&quot;, &quot;Online Orders Versus Rep Orders\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt, &quot; &quot;, &quot;Each Point shows Number of Orders: $ Amount: % of Total $ For the Month&quot; )) This plot is much easier to read, but the sales orders =&gt; avg_s From the tidy point of view overview, https://tidyr.tidyverse.org/: Tidy data is data where: Each variable is in a column. Each observation is a row. Each value is a cell. The gather command throws the following warning: attributes are not identical across measure variables; they will be dropped 8.5 Adventure Works Monthly Sales Instead of annual sales, we drill into the monthly sales to see how sales dollars are generated over the year. We also clean up our next graph a bit. The y-axis is re-scaled to make it easier to read and center the title. monthly_sales &lt;- tbl(con, in_schema(&quot;sales&quot;, &quot;salesorderheader&quot;)) %&gt;% mutate(order_date = substr(as.character(orderdate), 1, 7)) %&gt;% group_by(order_date) %&gt;% summarize( min_soh_orderdate = min(orderdate), max_soh_orderdate = max(orderdate), nbr_of_orders = n(), soh_dollars = round(sum(subtotal, na.rm = TRUE), 2) ) %&gt;% arrange(order_date) %&gt;% select(order_date, min_soh_orderdate, max_soh_orderdate, nbr_of_orders, soh_dollars) %&gt;% collect() %&gt;% as.data.frame() ## Warning: Missing values are always removed in SQL. ## Use `MIN(x, na.rm = TRUE)` to silence this warning ## This warning is displayed only once per session. ## Warning: Missing values are always removed in SQL. ## Use `MAX(x, na.rm = TRUE)` to silence this warning ## This warning is displayed only once per session. head(monthly_sales) ## order_date min_soh_orderdate max_soh_orderdate nbr_of_orders soh_dollars ## 1 2011-05 2011-05-31 2011-05-31 43 503805.92 ## 2 2011-06 2011-06-01 2011-06-30 141 458910.82 ## 3 2011-07 2011-07-01 2011-07-31 231 2044600.00 ## 4 2011-08 2011-08-01 2011-08-31 250 2495816.73 ## 5 2011-09 2011-09-01 2011-09-30 157 502073.85 ## 6 2011-10 2011-10-01 2011-10-31 327 4588761.82 sp_print_df(head(monthly_sales)) ggplot(data = monthly_sales, aes(x = min_soh_orderdate, y = soh_dollars)) + geom_line() + # fill = &#39;green&#39;, color = &#39;blue&#39;) + xlab(&quot;Year&quot;) + ylab(&quot;Sales&quot;) + scale_y_continuous(labels = dollar) + # see scales library ggtitle(paste(&quot;Sales by Month\\n&quot;, min_soh_dt, &quot; - &quot;, max_soh_dt)) + theme(plot.title = element_text(hjust = 0.5)) + # Center ggplot title theme(axis.text.x = element_text(angle = 60, hjust = 1)) 8.6 Close and clean up dbDisconnect(con) sp_docker_stop(&quot;adventureworks&quot;) "]
]
