<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Asking Business Questions From a Single Table | Exploring Enterprise Databases with R: A Tidyverse Approach</title>
  <meta name="description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Asking Business Questions From a Single Table | Exploring Enterprise Databases with R: A Tidyverse Approach" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Asking Business Questions From a Single Table | Exploring Enterprise Databases with R: A Tidyverse Approach" />
  
  <meta name="twitter:description" content="An introduction to Docker and PostgreSQL for R users to simulate use cases behind corporate walls." />
  

<meta name="author" content="John David Smith, Sophie Yang, M. Edward (Ed) Borasky, Jim Tyhurst, Scott Came, Mary Anne Thygesen, and Ian Frantz" />


<meta name="date" content="2020-01-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="chapter-dbms-queries-intro.html"/>
<link rel="next" href="chapter-lazy-evaluation-queries.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.11/datatables.js"></script>
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.19/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.19/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R, Databases and Docker</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#using-r-to-query-a-dbms-in-your-organization"><i class="fa fa-check"></i><b>1.1</b> Using R to query a DBMS in your organization</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#docker-as-a-tool-for-users"><i class="fa fa-check"></i><b>1.2</b> Docker as a tool for UseRs</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#alternatives-to-docker"><i class="fa fa-check"></i><b>1.3</b> Alternatives to Docker</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#packages-used-in-this-book"><i class="fa fa-check"></i><b>1.4</b> Packages used in this book</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#who-are-we"><i class="fa fa-check"></i><b>1.5</b> Who are we?</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#how-did-this-project-come-about"><i class="fa fa-check"></i><b>1.6</b> How did this project come about?</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#navigation"><i class="fa fa-check"></i><b>1.7</b> Navigation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html"><i class="fa fa-check"></i><b>2</b> How to use this book</a><ul>
<li class="chapter" data-level="2.1" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html#retrieve-the-code-from-github"><i class="fa fa-check"></i><b>2.1</b> Retrieve the code from GitHub</a></li>
<li class="chapter" data-level="2.2" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html#read-along-experiment-as-you-go"><i class="fa fa-check"></i><b>2.2</b> Read along, experiment as you go</a></li>
<li class="chapter" data-level="2.3" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html#participating"><i class="fa fa-check"></i><b>2.3</b> Participating</a><ul>
<li class="chapter" data-level="2.3.1" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html#browsing-the-book"><i class="fa fa-check"></i><b>2.3.1</b> Browsing the book</a></li>
<li class="chapter" data-level="2.3.2" data-path="chapter-how-to-use-this-book.html"><a href="chapter-how-to-use-this-book.html#diving-in"><i class="fa fa-check"></i><b>2.3.2</b> Diving in</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html"><i class="fa fa-check"></i><b>3</b> Chapter Learning Goals and Use Cases</a><ul>
<li class="chapter" data-level="3.1" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#the-books-challenge-goals-context-and-expectations"><i class="fa fa-check"></i><b>3.1</b> The Book’s Challenge: goals, context and expectations</a><ul>
<li class="chapter" data-level="3.1.1" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#the-challenge-investigating-a-question-using-an-organizations-database"><i class="fa fa-check"></i><b>3.1.1</b> The Challenge: Investigating a question using an organization’s database</a></li>
<li class="chapter" data-level="3.1.2" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#strategies"><i class="fa fa-check"></i><b>3.1.2</b> Strategies</a></li>
<li class="chapter" data-level="3.1.3" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#problems-that-we-address-in-the-book"><i class="fa fa-check"></i><b>3.1.3</b> Problems that we address in the book</a></li>
<li class="chapter" data-level="3.1.4" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#signposts"><i class="fa fa-check"></i><b>3.1.4</b> Signposts</a></li>
<li class="chapter" data-level="3.1.5" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#book-structure"><i class="fa fa-check"></i><b>3.1.5</b> Book structure</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#making-your-way-through-the-book"><i class="fa fa-check"></i><b>3.2</b> Making your way through the book</a><ul>
<li class="chapter" data-level="3.2.1" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#r-packages"><i class="fa fa-check"></i><b>3.2.1</b> R Packages</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="chapter-learning-goals.html"><a href="chapter-learning-goals.html#adventure-works"><i class="fa fa-check"></i><b>3.3</b> Adventure Works</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html"><i class="fa fa-check"></i><b>4</b> Create and connect to the adventureworks database in PostgreSQL</a><ul>
<li class="chapter" data-level="4.1" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#overview"><i class="fa fa-check"></i><b>4.1</b> Overview</a></li>
<li class="chapter" data-level="4.2" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#verify-that-docker-is-up-running-and-clean-up-if-necessary"><i class="fa fa-check"></i><b>4.2</b> Verify that Docker is up, running, and clean up if necessary</a></li>
<li class="chapter" data-level="4.3" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#clean-up-if-appropriate"><i class="fa fa-check"></i><b>4.3</b> Clean up if appropriate</a></li>
<li class="chapter" data-level="4.4" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#build-the-adventureworks-docker-image"><i class="fa fa-check"></i><b>4.4</b> Build the adventureworks Docker image</a></li>
<li class="chapter" data-level="4.5" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#run-the-adventureworks-docker-image"><i class="fa fa-check"></i><b>4.5</b> Run the adventureworks Docker Image</a></li>
<li class="chapter" data-level="4.6" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#connect-to-postgresql"><i class="fa fa-check"></i><b>4.6</b> Connect to PostgreSQL</a></li>
<li class="chapter" data-level="4.7" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#adventureworks-schemas"><i class="fa fa-check"></i><b>4.7</b> Adventureworks Schemas</a></li>
<li class="chapter" data-level="4.8" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#investigate-the-database-using-rstudio"><i class="fa fa-check"></i><b>4.8</b> Investigate the database using Rstudio</a></li>
<li class="chapter" data-level="4.9" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#cleaning-up-diconnect-from-the-database-and-stop-docker"><i class="fa fa-check"></i><b>4.9</b> Cleaning up: diconnect from the database and stop Docker</a></li>
<li class="chapter" data-level="4.10" data-path="chapter-setup-adventureworks-db.html"><a href="chapter-setup-adventureworks-db.html#using-the-adventureworks-container-in-the-rest-of-the-book"><i class="fa fa-check"></i><b>4.10</b> Using the <code>adventureworks</code> container in the rest of the book</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html"><i class="fa fa-check"></i><b>5</b> Securing and using your dbms log-in credentials</a><ul>
<li class="chapter" data-level="5.1" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#set-up-the-adventureworks-docker-container"><i class="fa fa-check"></i><b>5.1</b> Set up the adventureworks Docker container</a><ul>
<li class="chapter" data-level="5.1.1" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#verify-that-docker-is-running"><i class="fa fa-check"></i><b>5.1.1</b> Verify that Docker is running</a></li>
<li class="chapter" data-level="5.1.2" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#start-the-docker-container"><i class="fa fa-check"></i><b>5.1.2</b> Start the Docker container:</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#storing-your-dbms-credentials"><i class="fa fa-check"></i><b>5.2</b> Storing your dbms credentials</a><ul>
<li class="chapter" data-level="5.2.1" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#connect-with-postgres-using-the-sys.getenv-function"><i class="fa fa-check"></i><b>5.2.1</b> Connect with Postgres using the Sys.getenv function</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="chapter-dbms-login-credentials.html"><a href="chapter-dbms-login-credentials.html#disconnect-from-the-database-and-stop-docker"><i class="fa fa-check"></i><b>5.3</b> Disconnect from the database and stop Docker</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html"><i class="fa fa-check"></i><b>6</b> Connecting to the database with R code</a><ul>
<li class="chapter" data-level="6.1" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html#verify-that-docker-is-up-and-running-and-start-the-database"><i class="fa fa-check"></i><b>6.1</b> Verify that Docker is up and running, and start the database</a></li>
<li class="chapter" data-level="6.2" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html#connect-to-postgresql-1"><i class="fa fa-check"></i><b>6.2</b> Connect to PostgreSQL</a></li>
<li class="chapter" data-level="6.3" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html#set-schema-search-path-and-list-its-contents"><i class="fa fa-check"></i><b>6.3</b> Set schema search path and list its contents</a></li>
<li class="chapter" data-level="6.4" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html#anatomy-of-a-dplyr-connection-object"><i class="fa fa-check"></i><b>6.4</b> Anatomy of a <code>dplyr</code> connection object</a></li>
<li class="chapter" data-level="6.5" data-path="chapter-connect-to-db-with-r-code.html"><a href="chapter-connect-to-db-with-r-code.html#disconnect-from-the-database-and-stop-docker-1"><i class="fa fa-check"></i><b>6.5</b> Disconnect from the database and stop Docker</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html"><i class="fa fa-check"></i><b>7</b> Introduction to DBMS queries</a><ul>
<li class="chapter" data-level="7.1" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#setup"><i class="fa fa-check"></i><b>7.1</b> Setup</a></li>
<li class="chapter" data-level="7.2" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#methods-for-downloading-a-single-table"><i class="fa fa-check"></i><b>7.2</b> Methods for downloading a single table</a><ul>
<li class="chapter" data-level="7.2.1" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#read-the-entire-table"><i class="fa fa-check"></i><b>7.2.1</b> Read the entire table</a></li>
<li class="chapter" data-level="7.2.2" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#create-a-pointer-to-a-table-that-can-be-reused"><i class="fa fa-check"></i><b>7.2.2</b> Create a pointer to a table that can be reused</a></li>
<li class="chapter" data-level="7.2.3" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#controlling-the-number-of-rows-returned-with-collect"><i class="fa fa-check"></i><b>7.2.3</b> Controlling the number of rows returned with <code>collect()</code></a></li>
<li class="chapter" data-level="7.2.4" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#retrieving-random-rows-from-the-dbms"><i class="fa fa-check"></i><b>7.2.4</b> Retrieving random rows from the DBMS</a></li>
<li class="chapter" data-level="7.2.5" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#sub-setting-variables"><i class="fa fa-check"></i><b>7.2.5</b> Sub-setting variables</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#translating-dplyr-code-to-sql-queries"><i class="fa fa-check"></i><b>7.3</b> Translating <code>dplyr</code> code to <code>SQL</code> queries</a></li>
<li class="chapter" data-level="7.4" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#mixing-dplyr-and-sql"><i class="fa fa-check"></i><b>7.4</b> Mixing dplyr and SQL</a></li>
<li class="chapter" data-level="7.5" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#examining-a-single-table-with-r"><i class="fa fa-check"></i><b>7.5</b> Examining a single table with R</a><ul>
<li class="chapter" data-level="7.5.1" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#str---a-base-package-workhorse"><i class="fa fa-check"></i><b>7.5.1</b> <code>str</code> - a base package workhorse</a></li>
<li class="chapter" data-level="7.5.2" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#always-look-at-your-data-with-head-view-or-kable"><i class="fa fa-check"></i><b>7.5.2</b> Always <strong>look</strong> at your data with <code>head</code>, <code>View</code>, or <code>kable</code></a></li>
<li class="chapter" data-level="7.5.3" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#the-summary-function-in-base"><i class="fa fa-check"></i><b>7.5.3</b> The <code>summary</code> function in <code>base</code></a></li>
<li class="chapter" data-level="7.5.4" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#the-glimpse-function-in-the-tibble-package"><i class="fa fa-check"></i><b>7.5.4</b> The <code>glimpse</code> function in the <code>tibble</code> package</a></li>
<li class="chapter" data-level="7.5.5" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#the-skim-function-in-the-skimr-package"><i class="fa fa-check"></i><b>7.5.5</b> The <code>skim</code> function in the <code>skimr</code> package</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#disconnect-from-the-database-and-stop-docker-2"><i class="fa fa-check"></i><b>7.6</b> Disconnect from the database and stop Docker</a></li>
<li class="chapter" data-level="7.7" data-path="chapter-dbms-queries-intro.html"><a href="chapter-dbms-queries-intro.html#additional-reading"><i class="fa fa-check"></i><b>7.7</b> Additional reading</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html"><i class="fa fa-check"></i><b>8</b> Asking Business Questions From a Single Table</a><ul>
<li class="chapter" data-level="8.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#setup-our-standard-working-environment"><i class="fa fa-check"></i><b>8.1</b> Setup our standard working environment</a></li>
<li class="chapter" data-level="8.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#a-word-on-naming"><i class="fa fa-check"></i><b>8.2</b> A word on naming</a></li>
<li class="chapter" data-level="8.3" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#the-overall-adventureworks-sales-picture"><i class="fa fa-check"></i><b>8.3</b> The overall AdventureWorks sales picture</a></li>
<li class="chapter" data-level="8.4" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#annual-sales"><i class="fa fa-check"></i><b>8.4</b> Annual sales</a><ul>
<li class="chapter" data-level="8.4.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#annual-summary-of-sales-number-of-transactions-and-average-sale"><i class="fa fa-check"></i><b>8.4.1</b> Annual summary of sales, number of transactions and average sale</a></li>
<li class="chapter" data-level="8.4.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#average-dollars-per-sale"><i class="fa fa-check"></i><b>8.4.2</b> Average dollars per sale</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#monthly-sales"><i class="fa fa-check"></i><b>8.5</b> Monthly Sales</a><ul>
<li class="chapter" data-level="8.5.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#check-lagged-monthly-data"><i class="fa fa-check"></i><b>8.5.1</b> Check lagged monthly data</a></li>
<li class="chapter" data-level="8.5.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#comparing-dollars-and-orders-to-a-base-year"><i class="fa fa-check"></i><b>8.5.2</b> Comparing dollars and orders to a base year</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#the-effect-of-online-sales"><i class="fa fa-check"></i><b>8.6</b> The effect of online sales</a><ul>
<li class="chapter" data-level="8.6.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#add-onlineorderflag-to-our-annual-sales-query"><i class="fa fa-check"></i><b>8.6.1</b> Add <code>onlineorderflag</code> to our annual sales query</a></li>
<li class="chapter" data-level="8.6.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#annual-sales-comparison"><i class="fa fa-check"></i><b>8.6.2</b> Annual Sales comparison</a></li>
<li class="chapter" data-level="8.6.3" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#order-volume-comparison"><i class="fa fa-check"></i><b>8.6.3</b> Order volume comparison</a></li>
<li class="chapter" data-level="8.6.4" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#comparing-average-order-size-sales-reps-to-online-orders"><i class="fa fa-check"></i><b>8.6.4</b> Comparing average order size: <strong>Sales Reps</strong> to <strong>Online</strong> orders</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#impact-of-order-type-on-monthly-sales"><i class="fa fa-check"></i><b>8.7</b> Impact of order type on monthly sales</a><ul>
<li class="chapter" data-level="8.7.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#retrieve-monthly-sales-with-the-onlineorderflag"><i class="fa fa-check"></i><b>8.7.1</b> Retrieve monthly sales with the <code>onlineorderflag</code></a></li>
<li class="chapter" data-level="8.7.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#monthly-variation-compared-to-a-trend-line"><i class="fa fa-check"></i><b>8.7.2</b> Monthly variation compared to a trend line</a></li>
<li class="chapter" data-level="8.7.3" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#compare-monthly-lagged-data-by-sales-channel"><i class="fa fa-check"></i><b>8.7.3</b> Compare monthly lagged data by Sales Channel</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#detect-and-diagnose-the-day-of-the-month-problem"><i class="fa fa-check"></i><b>8.8</b> Detect and diagnose the day of the month problem</a><ul>
<li class="chapter" data-level="8.8.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#sales-rep-orderdate-distribution"><i class="fa fa-check"></i><b>8.8.1</b> Sales Rep Orderdate Distribution</a></li>
</ul></li>
<li class="chapter" data-level="8.9" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#correcting-the-order-date-for-sales-reps"><i class="fa fa-check"></i><b>8.9</b> Correcting the order date for <strong>Sales Reps</strong></a><ul>
<li class="chapter" data-level="8.9.1" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#define-a-date-correction-function-in-r"><i class="fa fa-check"></i><b>8.9.1</b> Define a date correction function in R</a></li>
<li class="chapter" data-level="8.9.2" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#define-postgres-date-function"><i class="fa fa-check"></i><b>8.9.2</b> Define and store a PostgreSQL function to correct the date</a></li>
<li class="chapter" data-level="8.9.3" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#use-the-postgresql-function"><i class="fa fa-check"></i><b>8.9.3</b> Use the PostgreSQL function</a></li>
<li class="chapter" data-level="8.9.4" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#monthly-sales-by-order-type-with-corrected-dates-relative-to-a-trend-line"><i class="fa fa-check"></i><b>8.9.4</b> Monthly Sales by Order Type with corrected dates – relative to a trend line</a></li>
</ul></li>
<li class="chapter" data-level="8.10" data-path="chapter-exploring-a-single-table.html"><a href="chapter-exploring-a-single-table.html#disconnect-from-the-database-and-stop-docker-3"><i class="fa fa-check"></i><b>8.10</b> Disconnect from the database and stop Docker</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html"><i class="fa fa-check"></i><b>9</b> Lazy Evaluation and Lazy Queries</a><ul>
<li class="chapter" data-level="9.1" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#setup-1"><i class="fa fa-check"></i><b>9.1</b> Setup</a></li>
<li class="chapter" data-level="9.2" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#r-is-lazy-and-comes-with-guardrails"><i class="fa fa-check"></i><b>9.2</b> R is lazy and comes with guardrails</a><ul>
<li class="chapter" data-level="9.2.1" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy-loading"><i class="fa fa-check"></i><b>9.2.1</b> Lazy loading</a></li>
<li class="chapter" data-level="9.2.2" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy-evaluation"><i class="fa fa-check"></i><b>9.2.2</b> Lazy evaluation</a></li>
<li class="chapter" data-level="9.2.3" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy-queries"><i class="fa fa-check"></i><b>9.2.3</b> Lazy Queries</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy-evaluation-and-lazy-queries"><i class="fa fa-check"></i><b>9.3</b> Lazy evaluation and lazy queries</a><ul>
<li class="chapter" data-level="9.3.1" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#create-a-black-box-query-for-experimentation"><i class="fa fa-check"></i><b>9.3.1</b> Create a black box query for experimentation</a></li>
<li class="chapter" data-level="9.3.2" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#experiment-overview"><i class="fa fa-check"></i><b>9.3.2</b> Experiment overview</a></li>
<li class="chapter" data-level="9.3.3" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_print"><i class="fa fa-check"></i><b>9.3.3</b> Q %&gt;% print()</a></li>
<li class="chapter" data-level="9.3.4" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_as-tibble"><i class="fa fa-check"></i><b>9.3.4</b> Q %&gt;% dplyr::as_tibble()</a></li>
<li class="chapter" data-level="9.3.5" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_head"><i class="fa fa-check"></i><b>9.3.5</b> Q %&gt;% head()</a></li>
<li class="chapter" data-level="9.3.6" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_tail"><i class="fa fa-check"></i><b>9.3.6</b> Q %&gt;% tail()</a></li>
<li class="chapter" data-level="9.3.7" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_length"><i class="fa fa-check"></i><b>9.3.7</b> Q %&gt;% length()</a></li>
<li class="chapter" data-level="9.3.8" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_str"><i class="fa fa-check"></i><b>9.3.8</b> Q %&gt;% str()</a></li>
<li class="chapter" data-level="9.3.9" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_nrow"><i class="fa fa-check"></i><b>9.3.9</b> Q %&gt;% nrow()</a></li>
<li class="chapter" data-level="9.3.10" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_tally"><i class="fa fa-check"></i><b>9.3.10</b> Q %&gt;% dplyr::tally()</a></li>
<li class="chapter" data-level="9.3.11" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_collect"><i class="fa fa-check"></i><b>9.3.11</b> Q %&gt;% dplyr::collect()</a></li>
<li class="chapter" data-level="9.3.12" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_plot-categories"><i class="fa fa-check"></i><b>9.3.12</b> Q %&gt;% ggplot</a></li>
<li class="chapter" data-level="9.3.13" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#lazy_q_show-query"><i class="fa fa-check"></i><b>9.3.13</b> Q %&gt;% dplyr::show_query()</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="chapter-lazy-evaluation-queries.html"><a href="chapter-lazy-evaluation-queries.html#other-resources"><i class="fa fa-check"></i><b>9.4</b> Other resources</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html"><i class="fa fa-check"></i><b>10</b> Lazy Evaluation and Execution Environment</a><ul>
<li class="chapter" data-level="10.1" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#setup-2"><i class="fa fa-check"></i><b>10.1</b> Setup</a><ul>
<li class="chapter" data-level="10.1.1" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#experiment-overview-1"><i class="fa fa-check"></i><b>10.1.1</b> Experiment overview</a></li>
<li class="chapter" data-level="10.1.2" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#time-based-execution-environment-issues"><i class="fa fa-check"></i><b>10.1.2</b> Time-based, execution environment issues</a></li>
<li class="chapter" data-level="10.1.3" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#lazy_q_build"><i class="fa fa-check"></i><b>10.1.3</b> Q %&gt;% <code>more dplyr</code></a></li>
<li class="chapter" data-level="10.1.4" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#many-handy-r-functions-cant-be-translated-to-sql"><i class="fa fa-check"></i><b>10.1.4</b> Many handy R functions can’t be translated to SQL</a></li>
<li class="chapter" data-level="10.1.5" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#further-lazy-execution-examples"><i class="fa fa-check"></i><b>10.1.5</b> Further lazy execution examples</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#disconnect-from-the-database-and-stop-docker-4"><i class="fa fa-check"></i><b>10.2</b> Disconnect from the database and stop Docker</a></li>
<li class="chapter" data-level="10.3" data-path="chapter-lazy-evaluation-and-timing.html"><a href="chapter-lazy-evaluation-and-timing.html#other-resources-1"><i class="fa fa-check"></i><b>10.3</b> Other resources</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html"><i class="fa fa-check"></i><b>11</b> Leveraging Database Views</a><ul>
<li class="chapter" data-level="11.1" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#setup-our-standard-working-environment-1"><i class="fa fa-check"></i><b>11.1</b> Setup our standard working environment</a></li>
<li class="chapter" data-level="11.2" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#the-role-of-database-views"><i class="fa fa-check"></i><b>11.2</b> The role of database <code>views</code></a><ul>
<li class="chapter" data-level="11.2.1" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#why-database-views-are-useful"><i class="fa fa-check"></i><b>11.2.1</b> Why database <code>views</code> are useful</a></li>
<li class="chapter" data-level="11.2.2" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#rely-on-and-be-critical-of-views"><i class="fa fa-check"></i><b>11.2.2</b> Rely on – <strong>and</strong> be critical of – <code>views</code></a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#unpacking-the-elements-of-a-view-in-the-tidyverse"><i class="fa fa-check"></i><b>11.3</b> Unpacking the elements of a <code>view</code> in the Tidyverse</a><ul>
<li class="chapter" data-level="11.3.1" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#use-a-view-just-like-any-other-table"><i class="fa fa-check"></i><b>11.3.1</b> Use a <code>view</code> just like any other table</a></li>
<li class="chapter" data-level="11.3.2" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#sql-source-code"><i class="fa fa-check"></i><b>11.3.2</b> SQL source code</a></li>
<li class="chapter" data-level="11.3.3" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#the-erd-as-context-for-sql-code"><i class="fa fa-check"></i><b>11.3.3</b> The ERD as context for SQL code</a></li>
<li class="chapter" data-level="11.3.4" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#selecting-relevant-tables-and-columns"><i class="fa fa-check"></i><b>11.3.4</b> Selecting relevant tables and columns</a></li>
<li class="chapter" data-level="11.3.5" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#join-the-tables-together"><i class="fa fa-check"></i><b>11.3.5</b> Join the tables together</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#compare-the-official-view-and-the-dplyr-output"><i class="fa fa-check"></i><b>11.4</b> Compare the official view and the dplyr output</a></li>
<li class="chapter" data-level="11.5" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#revise-the-view-to-summarize-by-quarter-not-fiscal-year"><i class="fa fa-check"></i><b>11.5</b> Revise the view to summarize by quarter not fiscal year</a></li>
<li class="chapter" data-level="11.6" data-path="chapter-leveraging-database-views.html"><a href="chapter-leveraging-database-views.html#clean-up-and-close-down"><i class="fa fa-check"></i><b>11.6</b> Clean up and close down</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html"><i class="fa fa-check"></i><b>12</b> Getting metadata about and from PostgreSQL</a><ul>
<li class="chapter" data-level="12.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#views-trick-parked-here-for-the-time-being"><i class="fa fa-check"></i><b>12.1</b> Views trick parked here for the time being</a><ul>
<li class="chapter" data-level="12.1.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#explore-the-vsalelsperson-and-vsalespersonsalesbyfiscalyearsdata-views"><i class="fa fa-check"></i><b>12.1.1</b> Explore the vsalelsperson and vsalespersonsalesbyfiscalyearsdata views</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#database-contents-and-structure"><i class="fa fa-check"></i><b>12.2</b> Database contents and structure</a><ul>
<li class="chapter" data-level="12.2.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#database-structure"><i class="fa fa-check"></i><b>12.2.1</b> Database structure</a></li>
<li class="chapter" data-level="12.2.2" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#contents-of-the-information_schema"><i class="fa fa-check"></i><b>12.2.2</b> Contents of the <code>information_schema</code></a></li>
<li class="chapter" data-level="12.2.3" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#what-tables-are-in-the-database"><i class="fa fa-check"></i><b>12.2.3</b> What tables are in the database?</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#what-columns-do-those-tables-contain"><i class="fa fa-check"></i><b>12.3</b> What columns do those tables contain?</a><ul>
<li class="chapter" data-level="12.3.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#what-is-the-difference-between-a-view-and-a-base-table"><i class="fa fa-check"></i><b>12.3.1</b> What is the difference between a <code>VIEW</code> and a <code>BASE TABLE</code>?</a></li>
<li class="chapter" data-level="12.3.2" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#what-data-types-are-found-in-the-database"><i class="fa fa-check"></i><b>12.3.2</b> What data types are found in the database?</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#characterizing-how-things-are-named"><i class="fa fa-check"></i><b>12.4</b> Characterizing how things are named</a><ul>
<li class="chapter" data-level="12.4.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#counting-columns-and-name-reuse"><i class="fa fa-check"></i><b>12.4.1</b> Counting columns and name reuse</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#database-keys"><i class="fa fa-check"></i><b>12.5</b> Database keys</a><ul>
<li class="chapter" data-level="12.5.1" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#direct-sql"><i class="fa fa-check"></i><b>12.5.1</b> Direct SQL</a></li>
<li class="chapter" data-level="12.5.2" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#database-keys-with-dplyr"><i class="fa fa-check"></i><b>12.5.2</b> Database keys with dplyr</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#creating-your-own-data-dictionary"><i class="fa fa-check"></i><b>12.6</b> Creating your own data dictionary</a></li>
<li class="chapter" data-level="12.7" data-path="chapter-postgresql-metadata.html"><a href="chapter-postgresql-metadata.html#save-your-work"><i class="fa fa-check"></i><b>12.7</b> Save your work!</a></li>
</ul></li>
<li class="appendix"><span><b>Appendices</b></span></li>
<li class="chapter" data-level="A" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html"><i class="fa fa-check"></i><b>A</b> Background and Basic Concepts</a><ul>
<li class="chapter" data-level="A.1" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#the-big-picture-r-and-the-docker-postgresql-playground-on-your-machine"><i class="fa fa-check"></i><b>A.1</b> The big picture: R and the Docker / PostgreSQL playground on your machine</a></li>
<li class="chapter" data-level="A.2" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#your-computer-and-its-operating-system"><i class="fa fa-check"></i><b>A.2</b> Your computer and its operating system</a></li>
<li class="chapter" data-level="A.3" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#r"><i class="fa fa-check"></i><b>A.3</b> R</a></li>
<li class="chapter" data-level="A.4" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#our-sqlpetr-package"><i class="fa fa-check"></i><b>A.4</b> Our <code>sqlpetr</code> package</a></li>
<li class="chapter" data-level="A.5" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#docker"><i class="fa fa-check"></i><b>A.5</b> Docker</a><ul>
<li class="chapter" data-level="A.5.1" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#virtual-machines-and-hypervisors"><i class="fa fa-check"></i><b>A.5.1</b> Virtual machines and hypervisors</a></li>
<li class="chapter" data-level="A.5.2" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#containers"><i class="fa fa-check"></i><b>A.5.2</b> Containers</a></li>
<li class="chapter" data-level="A.5.3" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#docker-itself"><i class="fa fa-check"></i><b>A.5.3</b> Docker itself</a></li>
<li class="chapter" data-level="A.5.4" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#docker-objects"><i class="fa fa-check"></i><b>A.5.4</b> Docker objects</a></li>
<li class="chapter" data-level="A.5.5" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#hosting-docker-on-windows-machines"><i class="fa fa-check"></i><b>A.5.5</b> Hosting Docker on Windows machines</a></li>
<li class="chapter" data-level="A.5.6" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#hosting-docker-on-macos-machines"><i class="fa fa-check"></i><b>A.5.6</b> Hosting Docker on macOS machines</a></li>
<li class="chapter" data-level="A.5.7" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#hosting-docker-on-unix-machines"><i class="fa fa-check"></i><b>A.5.7</b> Hosting Docker on UNIX machines</a></li>
</ul></li>
<li class="chapter" data-level="A.6" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#normal-and-normalized-data"><i class="fa fa-check"></i><b>A.6</b> ‘Normal’ and ‘normalized’ data</a><ul>
<li class="chapter" data-level="A.6.1" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#tidy-data"><i class="fa fa-check"></i><b>A.6.1</b> Tidy data</a></li>
<li class="chapter" data-level="A.6.2" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#design-of-normal-data"><i class="fa fa-check"></i><b>A.6.2</b> Design of “normal data”</a></li>
</ul></li>
<li class="chapter" data-level="A.7" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#sql-language"><i class="fa fa-check"></i><b>A.7</b> SQL Language</a><ul>
<li class="chapter" data-level="A.7.1" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#data-manipulation-langauge-dml"><i class="fa fa-check"></i><b>A.7.1</b> Data Manipulation Langauge (DML)</a></li>
<li class="chapter" data-level="A.7.2" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#data-definition-langauge-ddl"><i class="fa fa-check"></i><b>A.7.2</b> Data Definition Langauge (DDL)</a></li>
<li class="chapter" data-level="A.7.3" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#data-control-language-dcl"><i class="fa fa-check"></i><b>A.7.3</b> Data Control Language (DCL)</a></li>
<li class="chapter" data-level="A.7.4" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#transaction-control-language-tcl"><i class="fa fa-check"></i><b>A.7.4</b> Transaction Control Language (TCL)</a></li>
</ul></li>
<li class="chapter" data-level="A.8" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#enterprise-dbms"><i class="fa fa-check"></i><b>A.8</b> Enterprise DBMS</a><ul>
<li class="chapter" data-level="A.8.1" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#sql-databases"><i class="fa fa-check"></i><b>A.8.1</b> SQL databases</a></li>
<li class="chapter" data-level="A.8.2" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#data-mapping-between-r-vs-sql-data-types"><i class="fa fa-check"></i><b>A.8.2</b> Data mapping between R vs SQL data types</a></li>
<li class="chapter" data-level="A.8.3" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#postgresql-and-connection-parameters"><i class="fa fa-check"></i><b>A.8.3</b> PostgreSQL and connection parameters</a></li>
<li class="chapter" data-level="A.8.4" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#connecting-the-r-and-dbms-environments"><i class="fa fa-check"></i><b>A.8.4</b> Connecting the R and DBMS environments</a></li>
<li class="chapter" data-level="A.8.5" data-path="appendix-background-basic-concepts.html"><a href="appendix-background-basic-concepts.html#using-sqlite-to-simulate-an-enterprise-dbms"><i class="fa fa-check"></i><b>A.8.5</b> Using SQLite to simulate an enterprise DBMS</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="chapter-appendix-setup-instructions.html"><a href="chapter-appendix-setup-instructions.html"><i class="fa fa-check"></i><b>B</b> - Setup instructions</a><ul>
<li class="chapter" data-level="B.1" data-path="chapter-appendix-setup-instructions.html"><a href="chapter-appendix-setup-instructions.html#sandbox-prerequisites"><i class="fa fa-check"></i><b>B.1</b> Sandbox prerequisites</a></li>
<li class="chapter" data-level="B.2" data-path="chapter-appendix-setup-instructions.html"><a href="chapter-appendix-setup-instructions.html#r-rstudio-and-git"><i class="fa fa-check"></i><b>B.2</b> R, RStudio and Git</a></li>
<li class="chapter" data-level="B.3" data-path="chapter-appendix-setup-instructions.html"><a href="chapter-appendix-setup-instructions.html#install-docker"><i class="fa fa-check"></i><b>B.3</b> Install Docker</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html"><i class="fa fa-check"></i><b>C</b> Appendix E - Install <code>adventureworks</code> on your own machine</a><ul>
<li class="chapter" data-level="C.1" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html#overview-1"><i class="fa fa-check"></i><b>C.1</b> Overview</a><ul>
<li class="chapter" data-level="C.1.1" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html#download-the-adventureworks-database"><i class="fa fa-check"></i><b>C.1.1</b> Download the <code>adventureworks</code> database</a></li>
<li class="chapter" data-level="C.1.2" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html#restore-the-dvdrental-database-at-the-command-line"><i class="fa fa-check"></i><b>C.1.2</b> Restore the <code>dvdrental</code> database at the command line</a></li>
<li class="chapter" data-level="C.1.3" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html#restore-the-adventureworks-database-using-pgadmin"><i class="fa fa-check"></i><b>C.1.3</b> Restore the <code>adventureworks</code> database using pgAdmin</a></li>
</ul></li>
<li class="chapter" data-level="C.2" data-path="chapter-appendix-postgres-local-db-installation.html"><a href="chapter-appendix-postgres-local-db-installation.html#resources"><i class="fa fa-check"></i><b>C.2</b> Resources</a></li>
</ul></li>
<li class="chapter" data-level="D" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html"><i class="fa fa-check"></i><b>D</b> Appendix B - Additional technical details for Windows users</a><ul>
<li class="chapter" data-level="D.1" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#hardware-requirements"><i class="fa fa-check"></i><b>D.1</b> Hardware requirements</a></li>
<li class="chapter" data-level="D.2" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#software-requirements"><i class="fa fa-check"></i><b>D.2</b> Software requirements</a><ul>
<li class="chapter" data-level="D.2.1" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#windows-7-8-8.1-and-windows-10-home-64-bit"><i class="fa fa-check"></i><b>D.2.1</b> Windows 7, 8, 8.1 and Windows 10 Home (64 bit)</a></li>
<li class="chapter" data-level="D.2.2" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#windows-10-pro"><i class="fa fa-check"></i><b>D.2.2</b> Windows 10 Pro</a></li>
</ul></li>
<li class="chapter" data-level="D.3" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#docker-for-windows-settings"><i class="fa fa-check"></i><b>D.3</b> Docker for Windows settings</a><ul>
<li class="chapter" data-level="D.3.1" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#shared-drives"><i class="fa fa-check"></i><b>D.3.1</b> Shared drives</a></li>
<li class="chapter" data-level="D.3.2" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#kubernetes"><i class="fa fa-check"></i><b>D.3.2</b> Kubernetes</a></li>
</ul></li>
<li class="chapter" data-level="D.4" data-path="chapter-windows-tech-details.html"><a href="chapter-windows-tech-details.html#git-github-and-line-endings"><i class="fa fa-check"></i><b>D.4</b> Git, GitHub and line endings</a></li>
</ul></li>
<li class="chapter" data-level="E" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html"><i class="fa fa-check"></i><b>E</b> Appendix C - PostgreSQL Authentication</a><ul>
<li class="chapter" data-level="E.1" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#introduction"><i class="fa fa-check"></i><b>E.1</b> Introduction</a></li>
<li class="chapter" data-level="E.2" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#password-authentication-on-the-postgresql-docker-image"><i class="fa fa-check"></i><b>E.2</b> Password authentication on the PostgreSQL Docker image</a></li>
<li class="chapter" data-level="E.3" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#adding-roles"><i class="fa fa-check"></i><b>E.3</b> Adding roles</a><ul>
<li class="chapter" data-level="E.3.1" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#setting-up-docker"><i class="fa fa-check"></i><b>E.3.1</b> Setting up Docker</a></li>
<li class="chapter" data-level="E.3.2" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#creating-a-new-container"><i class="fa fa-check"></i><b>E.3.2</b> Creating a new container</a></li>
<li class="chapter" data-level="E.3.3" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#adding-a-role"><i class="fa fa-check"></i><b>E.3.3</b> Adding a role</a></li>
<li class="chapter" data-level="E.3.4" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#did-it-work"><i class="fa fa-check"></i><b>E.3.4</b> Did it work?</a></li>
<li class="chapter" data-level="E.3.5" data-path="chapter-appendix-postresql-authentication.html"><a href="chapter-appendix-postresql-authentication.html#disconnect-and-remove-the-container"><i class="fa fa-check"></i><b>E.3.5</b> Disconnect and remove the container</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="F" data-path="chapter-appendix-dbi-index.html"><a href="chapter-appendix-dbi-index.html"><i class="fa fa-check"></i><b>F</b> DBI package functions - INDEX</a></li>
<li class="chapter" data-level="G" data-path="chapter-appendix-dplyr-to-postres-translation.html"><a href="chapter-appendix-dplyr-to-postres-translation.html"><i class="fa fa-check"></i><b>G</b> Appendix _ Dplyr to SQL translations</a><ul>
<li class="chapter" data-level="G.1" data-path="chapter-appendix-dplyr-to-postres-translation.html"><a href="chapter-appendix-dplyr-to-postres-translation.html#overview-2"><i class="fa fa-check"></i><b>G.1</b> Overview</a></li>
</ul></li>
<li class="chapter" data-level="H" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html"><i class="fa fa-check"></i><b>H</b> Appendix Additional resources</a><ul>
<li class="chapter" data-level="H.1" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#editing-this-book"><i class="fa fa-check"></i><b>H.1</b> Editing this book</a></li>
<li class="chapter" data-level="H.2" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#docker-alternatives"><i class="fa fa-check"></i><b>H.2</b> Docker alternatives</a></li>
<li class="chapter" data-level="H.3" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#docker-and-r"><i class="fa fa-check"></i><b>H.3</b> Docker and R</a></li>
<li class="chapter" data-level="H.4" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#documentation-for-docker-and-postgresql"><i class="fa fa-check"></i><b>H.4</b> Documentation for Docker and PostgreSQL</a></li>
<li class="chapter" data-level="H.5" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#sql-and-dplyr"><i class="fa fa-check"></i><b>H.5</b> SQL and dplyr</a></li>
<li class="chapter" data-level="H.6" data-path="chapter-appendix-additional-resources.html"><a href="chapter-appendix-additional-resources.html#more-resources"><i class="fa fa-check"></i><b>H.6</b> More Resources</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Exploring Enterprise Databases with R: A Tidyverse Approach</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chapter_exploring-a-single-table" class="section level1">
<h1><span class="header-section-number">Chapter 8</span> Asking Business Questions From a Single Table</h1>
<blockquote>
<p>This chapter explores:</p>
<ul>
<li>Issues that come up when investigating a single table from a business perspective</li>
<li>Show the multiple data anomalies found in a single AdventureWorks table (<em>salesorderheader</em>)</li>
<li>The interplay between “data questions” and “business questions”</li>
</ul>
</blockquote>
<p>The previous chapter has demonstrated some of the automated techniques for showing what’s in a table using some standard R functions and packages. Now we demonstrate a step-by-step process of making sense of what’s in one table with more of a business perspective. We illustrate the kind of detective work that’s often involved as we investigate the <em>organizational meaning</em> of the data in a table. We’ll investigate the <code>salesorderheader</code> table in the <code>sales</code> schema in this example to understand the sales profile of the “AdventureWorks” business. We show that there are quite a few interpretation issues even when we are examining just 3 out of the 25 columns in one table.</p>
<p>For this kind of detective work we are seeking to understand the following elements separately and as they interact with each other:</p>
<ul>
<li>What data is stored in the database</li>
<li>How information is represented</li>
<li>How the data is entered at a day-to-day level to represent business activities</li>
<li>How the business itself is changing over time</li>
</ul>
<div id="setup-our-standard-working-environment" class="section level2">
<h2><span class="header-section-number">8.1</span> Setup our standard working environment</h2>
<p>Use these libraries:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb112-2" data-line-number="2"><span class="kw">library</span>(DBI)</a>
<a class="sourceLine" id="cb112-3" data-line-number="3"><span class="kw">library</span>(RPostgres)</a>
<a class="sourceLine" id="cb112-4" data-line-number="4"><span class="kw">library</span>(connections)</a>
<a class="sourceLine" id="cb112-5" data-line-number="5"><span class="kw">library</span>(glue)</a>
<a class="sourceLine" id="cb112-6" data-line-number="6"><span class="kw">require</span>(knitr)</a>
<a class="sourceLine" id="cb112-7" data-line-number="7"><span class="kw">library</span>(dbplyr)</a>
<a class="sourceLine" id="cb112-8" data-line-number="8"><span class="kw">library</span>(sqlpetr)</a>
<a class="sourceLine" id="cb112-9" data-line-number="9"><span class="kw">library</span>(bookdown)</a>
<a class="sourceLine" id="cb112-10" data-line-number="10"><span class="kw">library</span>(here)</a>
<a class="sourceLine" id="cb112-11" data-line-number="11"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb112-12" data-line-number="12"><span class="kw">library</span>(gt)</a>
<a class="sourceLine" id="cb112-13" data-line-number="13"><span class="kw">library</span>(scales)</a>
<a class="sourceLine" id="cb112-14" data-line-number="14"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb112-15" data-line-number="15"><span class="kw">theme_set</span>(<span class="kw">theme_light</span>())</a></code></pre></div>
<p>Connect to <code>adventureworks</code>. In an interactive session we prefer to use <code>connections::connection_open</code> instead of dbConnect</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="kw">sp_docker_start</span>(<span class="st">&quot;adventureworks&quot;</span>)</a>
<a class="sourceLine" id="cb113-2" data-line-number="2"><span class="kw">Sys.sleep</span>(sleep_default)</a>
<a class="sourceLine" id="cb113-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb113-4" data-line-number="4">  RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb113-5" data-line-number="5">  <span class="co"># without the previous and next lines, some functions fail with bigint data </span></a>
<a class="sourceLine" id="cb113-6" data-line-number="6">  <span class="co">#   so change int64 to integer</span></a>
<a class="sourceLine" id="cb113-7" data-line-number="7">  <span class="dt">bigint =</span> <span class="st">&quot;integer&quot;</span>,  </a>
<a class="sourceLine" id="cb113-8" data-line-number="8">  <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb113-9" data-line-number="9">  <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb113-10" data-line-number="10">  <span class="dt">user =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb113-11" data-line-number="11">  <span class="dt">password =</span> <span class="st">&quot;postgres&quot;</span>,</a>
<a class="sourceLine" id="cb113-12" data-line-number="12">  <span class="dt">dbname =</span> <span class="st">&quot;adventureworks&quot;</span>)</a></code></pre></div>
<p>Some queries generate big integers, so we need to include <code>RPostgres::Postgres()</code> and <code>bigint = &quot;integer&quot;</code> in the connections statement because some functions in the tidyverse object to the <strong>bigint</strong> datatype.</p>
</div>
<div id="a-word-on-naming" class="section level2">
<h2><span class="header-section-number">8.2</span> A word on naming</h2>
<blockquote>
<p>You will find that many tables will have columns with the same name in an enterprise database. For example, in the <em>AdventureWorks</em> database, almost all tables have columns named <code>rowguid</code> and <code>modifieddate</code> and there are many other examples of names that are reused throughout the database. Duplicate columns are best renamed or deliberately dropped. The meaning of a column depends on the table that contains it, so as you pull a column out of a table, when renaming it the collumns provenance should be reflected in the new name.</p>
<p>Naming columns carefully (whether retrieved from the database or calculated) will pay off, especially as our queries become more complex. Using <code>soh</code> as an abbreviation of <em>sales order header</em> to tag columns or statistics that are derived from the <code>salesorderheader</code> table, as we do in this book, is one example of an intentional naming strategy: it reminds us of the original source of the data. You, future you, and your collaborators will appreciate the effort no matter what naming convention you adopt. And a naming convention when rigidly applied can yield some long and ugly names.</p>
<p>In the following example <code>soh</code> appears in different positions in the column name but it is easy to guess at a glance that the data comes from the <code>salesorderheader</code> table.</p>
<p>Naming derived tables is just as important as naming derived columns.</p>
</blockquote>
</div>
<div id="the-overall-adventureworks-sales-picture" class="section level2">
<h2><span class="header-section-number">8.3</span> The overall AdventureWorks sales picture</h2>
<p>We begin by looking at Sales on a yearly basis, then consider monthly sales. We discover that half way through the period represented in the database, the business appears to begin selling online, which has very different characteristics than sales by Sales Reps. We then look at the details of how Sales Rep sales are recorded in the system and discover a data anomaly that we can correct.</p>
</div>
<div id="annual-sales" class="section level2">
<h2><span class="header-section-number">8.4</span> Annual sales</h2>
<p>On an annual basis, are sales dollars trending up, down or flat? We begin with annual revenue and number of orders.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" data-line-number="1">annual_sales &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">substr</span>(<span class="kw">as.character</span>(orderdate), <span class="dv">1</span>, <span class="dv">4</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb114-5" data-line-number="5">    <span class="dt">min_soh_orderdate =</span> <span class="kw">min</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb114-6" data-line-number="6">    <span class="dt">max_soh_orderdate =</span> <span class="kw">max</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb114-7" data-line-number="7">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb114-8" data-line-number="8">    <span class="dt">avg_total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">mean</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb114-9" data-line-number="9">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb114-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-11" data-line-number="11"><span class="st">  </span><span class="kw">arrange</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb114-13" data-line-number="13">    year, min_soh_orderdate, max_soh_orderdate, total_soh_dollars,</a>
<a class="sourceLine" id="cb114-14" data-line-number="14">    avg_total_soh_dollars, soh_count</a>
<a class="sourceLine" id="cb114-15" data-line-number="15">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-16" data-line-number="16"><span class="st">  </span><span class="kw">collect</span>() </a></code></pre></div>
<p>Note that all of this query is running on the server since the <code>collect()</code> statement is at the very end.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb115-1" data-line-number="1">annual_sales <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>()</a></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    4 obs. of  6 variables:
##  $ year                 : chr  &quot;2011&quot; &quot;2012&quot; &quot;2013&quot; &quot;2014&quot;
##  $ min_soh_orderdate    : POSIXct, format: &quot;2011-05-31&quot; &quot;2012-01-01&quot; ...
##  $ max_soh_orderdate    : POSIXct, format: &quot;2011-12-31&quot; &quot;2012-12-31&quot; ...
##  $ total_soh_dollars    : num  12641672 33524301 43622479 20057929
##  $ avg_total_soh_dollars: num  7867 8563 3076 1705
##  $ soh_count            : int  1607 3915 14182 11761</code></pre>
<p>We hang on to some date information for later use in plot titles.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" data-line-number="1">min_soh_dt &lt;-<span class="st"> </span><span class="kw">min</span>(annual_sales<span class="op">$</span>min_soh_orderdate)</a>
<a class="sourceLine" id="cb117-2" data-line-number="2">max_soh_dt &lt;-<span class="st"> </span><span class="kw">max</span>(annual_sales<span class="op">$</span>max_soh_orderdate)</a></code></pre></div>
<div id="annual-summary-of-sales-number-of-transactions-and-average-sale" class="section level3">
<h3><span class="header-section-number">8.4.1</span> Annual summary of sales, number of transactions and average sale</h3>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1">tot_sales &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> annual_sales, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> total_soh_dollars)) <span class="op">+</span></a>
<a class="sourceLine" id="cb118-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb118-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> <span class="kw">round</span>(<span class="kw">as.numeric</span>(total_soh_dollars), <span class="dt">digits =</span> <span class="dv">0</span>)), <span class="dt">vjust =</span> <span class="fl">-0.25</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb118-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb118-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb118-6" data-line-number="6">    <span class="dt">title =</span> <span class="st">&quot;AdventureWorks Total Sales by Year&quot;</span>,</a>
<a class="sourceLine" id="cb118-7" data-line-number="7">    <span class="dt">x =</span> <span class="kw">glue</span>(<span class="st">&quot;Years between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; and  &quot;</span>, </a>
<a class="sourceLine" id="cb118-8" data-line-number="8">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb118-9" data-line-number="9">    <span class="dt">y =</span> <span class="st">&quot;Sales $&quot;</span></a>
<a class="sourceLine" id="cb118-10" data-line-number="10">  )</a></code></pre></div>
<p>Both 2011 and 2014 turn out to be are shorter time spans than the other two years, making comparison interpretation difficult. Still, it’s clear that 2013 was the best year for annual sales dollars.</p>
<p>Comparing the number of orders per year has roughly the same overall pattern (2013 ranks highest, etc.) but the proportions between the years are quite different.</p>
<p>Although 2013 was the best year in terms of total number of orders, there were many more in 2014 compared with 2012. That suggests looking at the average dollars per sale for each year.</p>
</div>
<div id="average-dollars-per-sale" class="section level3">
<h3><span class="header-section-number">8.4.2</span> Average dollars per sale</h3>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1">(tot_sales <span class="op">+</span><span class="st"> </span>num_orders) <span class="op">/</span><span class="st"> </span>avg_sale</a></code></pre></div>
<p><img src="083-exploring-a-single-table_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>That’s a big drop between average sale of more than $7,000 in the first two years down to the $3,000 range in the last two. There has been a remarkable change in this business. At the same time the total number of orders shot up from less than 4,000 a year to more than 14,000. <strong>Why are the number of orders increasing, but the average dollar amount of a sale is dropping? </strong></p>
<p>Perhaps monthly monthly sales has the anser. We adapt the first query to group by month and year.</p>
</div>
</div>
<div id="monthly-sales" class="section level2">
<h2><span class="header-section-number">8.5</span> Monthly Sales</h2>
<p>Our next iteration drills down from annual sales dollars to monthly sales dollars. For that we download the orderdate as a date, rather than a character variable for the year. R handles the conversion from the PostgreSQL date-time to an R date-time. We then convert it to a simple date with a <code>lubridate</code> function.</p>
<p>The following query uses the <a href="https://www.postgresqltutorial.com/postgresql-date_trunc/">postgreSQL function <code>date_trunc</code></a>, which is equivalent to <code>lubridate</code>’s <code>round_date</code> function in R. If you want to push as much of the processing as possible onto the database server and thus possibly deal with smaller datasets in R, interleaving <a href="https://www.postgresql.org/docs/current/functions.html">postgreSQL functions</a> into your dplyr code will help.</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1">monthly_sales &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb120-4" data-line-number="4">    <span class="dt">orderdate =</span> <span class="kw">date_trunc</span>(<span class="st">&#39;month&#39;</span>, orderdate)</a>
<a class="sourceLine" id="cb120-5" data-line-number="5">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(orderdate) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-7" data-line-number="7"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb120-8" data-line-number="8">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb120-9" data-line-number="9">    <span class="dt">avg_total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">mean</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb120-10" data-line-number="10">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb120-11" data-line-number="11">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb120-12" data-line-number="12"><span class="st">  </span><span class="kw">show_query</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb120-13" data-line-number="13"><span class="st">  </span><span class="kw">collect</span>() </a></code></pre></div>
<pre><code>## &lt;SQL&gt;
## SELECT &quot;orderdate&quot;, ROUND((SUM(&quot;subtotal&quot;)) :: numeric, 2) AS &quot;total_soh_dollars&quot;, ROUND((AVG(&quot;subtotal&quot;)) :: numeric, 2) AS &quot;avg_total_soh_dollars&quot;, COUNT(*) AS &quot;soh_count&quot;
## FROM (SELECT date_trunc(&#39;month&#39;, &quot;orderdate&quot;) AS &quot;orderdate&quot;, &quot;subtotal&quot;
## FROM sales.salesorderheader) &quot;dbplyr_004&quot;
## GROUP BY &quot;orderdate&quot;</code></pre>
<blockquote>
<p>Note that <code>date_trunc('month', orderdate)</code> gets passed through exactly “as is.”</p>
</blockquote>
<p>In many cases we don’t really care whether our queries are executed by R or by the SQL server, but if we do care we need to substitute the <code>postgreSQL</code> equivalent for the R functions we might ordinarily use. In those cases we have to check whether functions from R packages like <code>lubridate</code> and the equivalent <code>postgreSQL</code> functions are exactly alike. Often they are subtly different: in the previous query the <code>postgreSQL</code> function produces a <code>POSIXct</code> column, not a <code>Date</code> so we need to tack on a mutate function once the data is on the R side as shown here:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1">monthly_sales &lt;-<span class="st">  </span>monthly_sales <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orderdate =</span> <span class="kw">as.Date</span>(orderdate))</a></code></pre></div>
<p>Next let’s plot the monthly sales data:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> monthly_sales, <span class="kw">aes</span>(<span class="dt">x =</span> orderdate, <span class="dt">y =</span> total_soh_dollars)) <span class="op">+</span></a>
<a class="sourceLine" id="cb123-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb123-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb123-4" data-line-number="4"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb123-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb123-6" data-line-number="6">    <span class="dt">title =</span> <span class="kw">glue</span>(<span class="st">&quot;Sales by Month</span><span class="ch">\n</span><span class="st">&quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; to  &quot;</span>, </a>
<a class="sourceLine" id="cb123-7" data-line-number="7">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb123-8" data-line-number="8">    <span class="dt">x =</span> <span class="st">&quot;Month&quot;</span>,</a>
<a class="sourceLine" id="cb123-9" data-line-number="9">    <span class="dt">y =</span> <span class="st">&quot;Sales Dollars&quot;</span></a>
<a class="sourceLine" id="cb123-10" data-line-number="10">  )</a></code></pre></div>
<div class="figure">
<img src="083-exploring-a-single-table_files/figure-html/Total%20monthly%20sales%20bar%20chart-1.png" alt="Total Monthly Sales" width="672" />
<p class="caption">
(#fig:Total monthly sales bar chart)Total Monthly Sales
</p>
</div>
<p>That graph doesn’t show how the business might have changed, but it is remarkable how much variation there is from one month to another – particularly in 2012 and 2014.</p>
<div id="check-lagged-monthly-data" class="section level3">
<h3><span class="header-section-number">8.5.1</span> Check lagged monthly data</h3>
<p>Because of the month-over-month sales variation. We’ll use <code>dplyr::lag</code> to help find the delta and later visualize just how much month-to-month difference there is.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">monthly_sales &lt;-<span class="st"> </span><span class="kw">arrange</span>(monthly_sales, orderdate)</a>
<a class="sourceLine" id="cb124-2" data-line-number="2"></a>
<a class="sourceLine" id="cb124-3" data-line-number="3">monthly_sales_lagged &lt;-<span class="st"> </span>monthly_sales <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb124-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">monthly_sales_change =</span> (dplyr<span class="op">::</span><span class="kw">lag</span>(total_soh_dollars)) <span class="op">-</span><span class="st"> </span>total_soh_dollars)</a>
<a class="sourceLine" id="cb124-5" data-line-number="5"></a>
<a class="sourceLine" id="cb124-6" data-line-number="6">monthly_sales_lagged[<span class="kw">is.na</span>(monthly_sales_lagged)] =<span class="st"> </span><span class="dv">0</span></a></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1"><span class="kw">median</span>(monthly_sales_lagged<span class="op">$</span>monthly_sales_change, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] -221690.505</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" data-line-number="1">(sum_lags &lt;-<span class="st"> </span><span class="kw">summary</span>(monthly_sales_lagged<span class="op">$</span>monthly_sales_change))</a></code></pre></div>
<pre><code>##        Min.     1st Qu.      Median        Mean     3rd Qu.        Max. 
## -5879806.05 -1172995.19  -221690.51    11968.42  1159252.70  5420357.17</code></pre>
<p>The average month over month change in sales looks OK ($ 11,968) although the Median is negative: $ 11,968. There is a very wide spread in our month-over-month sales data between the lower and upper quartile. We can plot the variation as follows:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1"><span class="kw">ggplot</span>(monthly_sales_lagged, <span class="kw">aes</span>(<span class="dt">x =</span> orderdate, <span class="dt">y =</span> monthly_sales_change)) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-2" data-line-number="2"><span class="st">  </span><span class="kw">scale_x_date</span>(<span class="dt">date_breaks =</span> <span class="st">&quot;year&quot;</span>, <span class="dt">date_labels =</span> <span class="st">&quot;%Y&quot;</span>, <span class="dt">date_minor_breaks =</span> <span class="st">&quot;3 months&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb129-4" data-line-number="4"><span class="st">  </span><span class="co"># geom_point() +</span></a>
<a class="sourceLine" id="cb129-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6000000</span>,<span class="dv">5500000</span>), <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb129-6" data-line-number="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">.5</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb129-8" data-line-number="8">    <span class="dt">title =</span> <span class="kw">glue</span>(</a>
<a class="sourceLine" id="cb129-9" data-line-number="9">      <span class="st">&quot;Monthly Sales Change </span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb129-10" data-line-number="10">      <span class="st">&quot;Between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; and  &quot;</span>, </a>
<a class="sourceLine" id="cb129-11" data-line-number="11">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}</a>
<a class="sourceLine" id="cb129-12" data-line-number="12">    ),</a>
<a class="sourceLine" id="cb129-13" data-line-number="13">    <span class="dt">x =</span> <span class="st">&quot;Month&quot;</span>,</a>
<a class="sourceLine" id="cb129-14" data-line-number="14">    <span class="dt">y =</span> <span class="st">&quot;Dollar Change&quot;</span></a>
<a class="sourceLine" id="cb129-15" data-line-number="15">  )</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-6"></span>
<img src="083-exploring-a-single-table_files/figure-html/unnamed-chunk-6-1.png" alt="Monthly Sales Change" width="672" />
<p class="caption">
Figure 8.1: Monthly Sales Change
</p>
</div>
<p>It looks like the big change in the business occurred in the summer of 2013 when the number of orders jumped but the dollar volume just continued to bump along.</p>
</div>
<div id="comparing-dollars-and-orders-to-a-base-year" class="section level3">
<h3><span class="header-section-number">8.5.2</span> Comparing dollars and orders to a base year</h3>
<p>To look at dollars and the number of orders together, we compare the monthly data to the yearly average for 2011.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" data-line-number="1">start_year &lt;-<span class="st"> </span>monthly_sales <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yr =</span> <span class="kw">year</span>(orderdate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(yr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb130-5" data-line-number="5">    <span class="dt">total_soh_dollars =</span> <span class="kw">sum</span>(total_soh_dollars),</a>
<a class="sourceLine" id="cb130-6" data-line-number="6">    <span class="dt">soh_count =</span> <span class="kw">sum</span>(soh_count),</a>
<a class="sourceLine" id="cb130-7" data-line-number="7">    <span class="dt">n_months =</span> <span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb130-8" data-line-number="8">    <span class="dt">avg_dollars =</span> total_soh_dollars <span class="op">/</span><span class="st"> </span>n_months,</a>
<a class="sourceLine" id="cb130-9" data-line-number="9">    <span class="dt">avg_count =</span> soh_count <span class="op">/</span><span class="st"> </span>n_months</a>
<a class="sourceLine" id="cb130-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb130-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(yr <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(yr))</a></code></pre></div>
<p>Use 2011 as a baseline:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1">start_year</a></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##      yr total_soh_dollars soh_count n_months avg_dollars avg_count
##   &lt;dbl&gt;             &lt;dbl&gt;     &lt;int&gt;    &lt;int&gt;       &lt;dbl&gt;     &lt;dbl&gt;
## 1  2011         12641672.      1607        8    1580209.      201.</code></pre>
<p>Express monthly data relative to 2011`</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1">monthly_sales_base_year_normalized_to_<span class="dv">2011</span> &lt;-<span class="st"> </span>monthly_sales <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb133-3" data-line-number="3">    <span class="dt">dollars =</span> (<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>total_soh_dollars) <span class="op">/</span><span class="st"> </span>start_year<span class="op">$</span>avg_dollars,</a>
<a class="sourceLine" id="cb133-4" data-line-number="4">    <span class="dt">number_of_orders =</span> (<span class="dv">100</span> <span class="op">*</span><span class="st"> </span>soh_count) <span class="op">/</span><span class="st"> </span>start_year<span class="op">$</span>avg_count</a>
<a class="sourceLine" id="cb133-5" data-line-number="5">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-6" data-line-number="6"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb133-7" data-line-number="7"></a>
<a class="sourceLine" id="cb133-8" data-line-number="8">monthly_sales_base_year_normalized_to_<span class="dv">2011</span> &lt;-<span class="st"> </span>monthly_sales_base_year_normalized_to_<span class="dv">2011</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(orderdate, dollars, <span class="st">`</span><span class="dt"># of orders</span><span class="st">`</span> =<span class="st"> </span>number_of_orders) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-10" data-line-number="10"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>orderdate,</a>
<a class="sourceLine" id="cb133-11" data-line-number="11">    <span class="dt">names_to =</span> <span class="st">&quot;relative_to_2011_average&quot;</span>,</a>
<a class="sourceLine" id="cb133-12" data-line-number="12">    <span class="dt">values_to =</span> <span class="st">&quot;amount&quot;</span></a>
<a class="sourceLine" id="cb133-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb133-14" data-line-number="14"></a>
<a class="sourceLine" id="cb133-15" data-line-number="15">monthly_sales_base_year_normalized_to_<span class="dv">2011</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-16" data-line-number="16"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(orderdate, amount, <span class="dt">color =</span> relative_to_<span class="dv">2011</span>_average)) <span class="op">+</span></a>
<a class="sourceLine" id="cb133-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb133-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">100</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb133-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_x_date</span>(<span class="dt">date_labels =</span> <span class="st">&quot;%Y-%m&quot;</span>, <span class="dt">date_breaks =</span> <span class="st">&quot;6 months&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb133-20" data-line-number="20"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb133-21" data-line-number="21">    <span class="dt">title =</span> <span class="kw">glue</span>(</a>
<a class="sourceLine" id="cb133-22" data-line-number="22">      <span class="st">&quot;Adventureworks Normalized Monthly Sales</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb133-23" data-line-number="23">      <span class="st">&quot;Number of Sales Orders and Dollar Totals</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb133-24" data-line-number="24">      {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; to  &quot;</span>, </a>
<a class="sourceLine" id="cb133-25" data-line-number="25">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb133-26" data-line-number="26">    <span class="dt">x =</span> <span class="st">&quot;Date&quot;</span>,</a>
<a class="sourceLine" id="cb133-27" data-line-number="27">    <span class="dt">y =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb133-28" data-line-number="28">    <span class="dt">color =</span> <span class="st">&quot;% change from</span><span class="ch">\n</span><span class="st"> 2011 average&quot;</span></a>
<a class="sourceLine" id="cb133-29" data-line-number="29">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb133-30" data-line-number="30"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">3</span>,.<span class="dv">75</span>))</a></code></pre></div>
<div class="figure"><span id="fig:unnamed-chunk-9"></span>
<img src="083-exploring-a-single-table_files/figure-html/unnamed-chunk-9-1.png" alt="Miscellaneous plots" width="672" />
<p class="caption">
Figure 8.2: Miscellaneous plots
</p>
</div>
</div>
</div>
<div id="the-effect-of-online-sales" class="section level2">
<h2><span class="header-section-number">8.6</span> The effect of online sales</h2>
<p>We suspect that the business has changed a lot with the advent of online orders so we check the impact of <code>onlineorderflag</code> on annual sales. The <code>onlineorderflag</code> indicates which sales channel accounted for the sale, <strong>Sales Reps</strong> or <strong>Online</strong>.</p>
<div id="add-onlineorderflag-to-our-annual-sales-query" class="section level3">
<h3><span class="header-section-number">8.6.1</span> Add <code>onlineorderflag</code> to our annual sales query</h3>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1">annual_sales_w_channel &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb134-5" data-line-number="5">    <span class="dt">orderdate =</span> <span class="kw">date</span>(orderdate),</a>
<a class="sourceLine" id="cb134-6" data-line-number="6">    <span class="dt">orderdate =</span> <span class="kw">round_date</span>(orderdate, <span class="st">&quot;year&quot;</span>),</a>
<a class="sourceLine" id="cb134-7" data-line-number="7">    <span class="dt">onlineorderflag =</span> <span class="kw">if_else</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb134-8" data-line-number="8">      <span class="st">&quot;Sales Rep&quot;</span>, <span class="st">&quot;Online&quot;</span></a>
<a class="sourceLine" id="cb134-9" data-line-number="9">    ),</a>
<a class="sourceLine" id="cb134-10" data-line-number="10">    <span class="dt">onlineorderflag =</span> <span class="kw">as.factor</span>(onlineorderflag)</a>
<a class="sourceLine" id="cb134-11" data-line-number="11">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-12" data-line-number="12"><span class="st">  </span><span class="kw">group_by</span>(orderdate, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-13" data-line-number="13"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb134-14" data-line-number="14">    <span class="dt">min_soh_orderdate =</span> <span class="kw">min</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb134-15" data-line-number="15">    <span class="dt">max_soh_orderdate =</span> <span class="kw">max</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb134-16" data-line-number="16">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb134-17" data-line-number="17">    <span class="dt">avg_total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">mean</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb134-18" data-line-number="18">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb134-19" data-line-number="19">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb134-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb134-21" data-line-number="21">    orderdate, onlineorderflag, min_soh_orderdate,</a>
<a class="sourceLine" id="cb134-22" data-line-number="22">    max_soh_orderdate, total_soh_dollars,</a>
<a class="sourceLine" id="cb134-23" data-line-number="23">    avg_total_soh_dollars, soh_count</a>
<a class="sourceLine" id="cb134-24" data-line-number="24">  )</a></code></pre></div>
<p>Note that we are creating a factor and doing most of the calculations on the R side, not on the DBMS side.</p>
</div>
<div id="annual-sales-comparison" class="section level3">
<h3><span class="header-section-number">8.6.2</span> Annual Sales comparison</h3>
<p>Start by looking at total sales.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> annual_sales_w_channel, <span class="kw">aes</span>(<span class="dt">x =</span> orderdate, <span class="dt">y =</span> total_soh_dollars)) <span class="op">+</span></a>
<a class="sourceLine" id="cb135-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb135-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb135-4" data-line-number="4"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="st">&quot;onlineorderflag&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb135-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb135-6" data-line-number="6">    <span class="dt">title =</span> <span class="st">&quot;AdventureWorks Sales Dollars by Year&quot;</span>,</a>
<a class="sourceLine" id="cb135-7" data-line-number="7">    <span class="dt">caption =</span> <span class="kw">glue</span>( <span class="st">&quot;Between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; - &quot;</span>, </a>
<a class="sourceLine" id="cb135-8" data-line-number="8">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb135-9" data-line-number="9">    <span class="dt">subtitle =</span> <span class="st">&quot;Comparing Online and Sales Rep sales channels&quot;</span>,</a>
<a class="sourceLine" id="cb135-10" data-line-number="10">    <span class="dt">x =</span> <span class="st">&quot;Year&quot;</span>,</a>
<a class="sourceLine" id="cb135-11" data-line-number="11">    <span class="dt">y =</span> <span class="st">&quot;Sales $&quot;</span></a>
<a class="sourceLine" id="cb135-12" data-line-number="12">  )</a></code></pre></div>
<div class="figure">
<img src="083-exploring-a-single-table_files/figure-html/Calculate%20annual%20sales%20dollars%20-1.png" alt="Sales Channel Breakdown" width="672" />
<p class="caption">
(#fig:Calculate annual sales dollars )Sales Channel Breakdown
</p>
</div>
<p>Based on annual sales, it looks like there are two businesses represented in the AdventureWorks database that have very different growth profiles.</p>
</div>
<div id="order-volume-comparison" class="section level3">
<h3><span class="header-section-number">8.6.3</span> Order volume comparison</h3>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> annual_sales_w_channel, <span class="kw">aes</span>(<span class="dt">x =</span> orderdate, <span class="dt">y =</span> <span class="kw">as.numeric</span>(soh_count))) <span class="op">+</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb136-3" data-line-number="3"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="st">&quot;onlineorderflag&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb136-4" data-line-number="4"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb136-5" data-line-number="5">    <span class="dt">title =</span> <span class="st">&quot;AdventureWorks Number of orders per Year&quot;</span>,</a>
<a class="sourceLine" id="cb136-6" data-line-number="6">    <span class="dt">caption =</span> <span class="kw">glue</span>( <span class="st">&quot;Between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; - &quot;</span>, </a>
<a class="sourceLine" id="cb136-7" data-line-number="7">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb136-8" data-line-number="8">    <span class="dt">subtitle =</span> <span class="st">&quot;Comparing Online and Sales Rep sales channels&quot;</span>,</a>
<a class="sourceLine" id="cb136-9" data-line-number="9">    <span class="dt">x =</span> <span class="st">&quot;Year&quot;</span>,</a>
<a class="sourceLine" id="cb136-10" data-line-number="10">    <span class="dt">y =</span> <span class="st">&quot;Total number of orders&quot;</span></a>
<a class="sourceLine" id="cb136-11" data-line-number="11">  )</a></code></pre></div>
<div class="figure">
<img src="083-exploring-a-single-table_files/figure-html/average%20dollars%20per%20sale%20-%20v4-1.png" alt="Average Dollars by Channel" width="672" />
<p class="caption">
(#fig:average dollars per sale - v4)Average Dollars by Channel
</p>
</div>
<p>Comparing Online and Sales Rep sales, the difference in the number of orders is even more striking than the difference between annual sales.</p>
</div>
<div id="comparing-average-order-size-sales-reps-to-online-orders" class="section level3">
<h3><span class="header-section-number">8.6.4</span> Comparing average order size: <strong>Sales Reps</strong> to <strong>Online</strong> orders</h3>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> annual_sales_w_channel, <span class="kw">aes</span>(<span class="dt">x =</span> orderdate, <span class="dt">y =</span> avg_total_soh_dollars)) <span class="op">+</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb137-3" data-line-number="3"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="st">&quot;onlineorderflag&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb137-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">dollar_format</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb137-5" data-line-number="5"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb137-6" data-line-number="6">    <span class="dt">title =</span> <span class="st">&quot;AdventureWorks Average Dollars per Sale&quot;</span>,</a>
<a class="sourceLine" id="cb137-7" data-line-number="7">    <span class="dt">x =</span> <span class="kw">glue</span>( <span class="st">&quot;Year - between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; - &quot;</span>, </a>
<a class="sourceLine" id="cb137-8" data-line-number="8">            {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb137-9" data-line-number="9">    <span class="dt">y =</span> <span class="st">&quot;Average sale amount&quot;</span></a>
<a class="sourceLine" id="cb137-10" data-line-number="10">  )</a></code></pre></div>
<div class="figure">
<img src="083-exploring-a-single-table_files/figure-html/average%20dollars%20per%20sale%203-1.png" alt="Sales Rep to Online comparison" width="672" />
<p class="caption">
(#fig:average dollars per sale 3)Sales Rep to Online comparison
</p>
</div>
</div>
</div>
<div id="impact-of-order-type-on-monthly-sales" class="section level2">
<h2><span class="header-section-number">8.7</span> Impact of order type on monthly sales</h2>
<p>To dig into the difference between <strong>Sales Rep</strong> and <strong>Online</strong> sales we can look at monthly data.</p>
<div id="retrieve-monthly-sales-with-the-onlineorderflag" class="section level3">
<h3><span class="header-section-number">8.7.1</span> Retrieve monthly sales with the <code>onlineorderflag</code></h3>
<p>This query puts the <code>collect</code> statement earlier than the previous queries.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1">monthly_sales_w_channel &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-3" data-line-number="3"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># From here on we&#39;re in R</span></a>
<a class="sourceLine" id="cb138-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb138-5" data-line-number="5">    <span class="dt">orderdate =</span> <span class="kw">date</span>(orderdate),</a>
<a class="sourceLine" id="cb138-6" data-line-number="6">    <span class="dt">orderdate =</span> <span class="kw">floor_date</span>(orderdate, <span class="dt">unit =</span> <span class="st">&quot;month&quot;</span>),</a>
<a class="sourceLine" id="cb138-7" data-line-number="7">    <span class="dt">onlineorderflag =</span> <span class="kw">if_else</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb138-8" data-line-number="8">      <span class="st">&quot;Sales Rep&quot;</span>, <span class="st">&quot;Online&quot;</span>)</a>
<a class="sourceLine" id="cb138-9" data-line-number="9">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb138-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(orderdate, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-11" data-line-number="11"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb138-12" data-line-number="12">    <span class="dt">min_soh_orderdate =</span> <span class="kw">min</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb138-13" data-line-number="13">    <span class="dt">max_soh_orderdate =</span> <span class="kw">max</span>(orderdate, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb138-14" data-line-number="14">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb138-15" data-line-number="15">    <span class="dt">avg_total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">mean</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb138-16" data-line-number="16">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb138-17" data-line-number="17">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb138-18" data-line-number="18"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1">monthly_sales_w_channel <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-2" data-line-number="2"><span class="st">  </span><span class="kw">rename</span>(<span class="st">`</span><span class="dt">Sales Channel</span><span class="st">`</span> =<span class="st"> </span>onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Sales Channel</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb139-5" data-line-number="5">    <span class="dt">unique_dates =</span> <span class="kw">n</span>(),</a>
<a class="sourceLine" id="cb139-6" data-line-number="6">    <span class="dt">start_date =</span> <span class="kw">min</span>(min_soh_orderdate),</a>
<a class="sourceLine" id="cb139-7" data-line-number="7">    <span class="dt">end_date =</span> <span class="kw">max</span>(max_soh_orderdate),</a>
<a class="sourceLine" id="cb139-8" data-line-number="8">    <span class="dt">total_sales =</span> <span class="kw">round</span>(<span class="kw">sum</span>(total_soh_dollars)), </a>
<a class="sourceLine" id="cb139-9" data-line-number="9">    <span class="dt">days_span =</span> end_date <span class="op">-</span><span class="st"> </span>start_date</a>
<a class="sourceLine" id="cb139-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb139-11" data-line-number="11"><span class="st">  </span><span class="kw">gt</span>()</a></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#pzveloiefp .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  /* table.margin.left */
  margin-right: auto;
  /* table.margin.right */
  color: #333333;
  font-size: 16px;
  /* table.font.size */
  background-color: #FFFFFF;
  /* table.background.color */
  width: auto;
  /* table.width */
  border-top-style: solid;
  /* table.border.top.style */
  border-top-width: 2px;
  /* table.border.top.width */
  border-top-color: #A8A8A8;
  /* table.border.top.color */
  border-bottom-style: solid;
  /* table.border.bottom.style */
  border-bottom-width: 2px;
  /* table.border.bottom.width */
  border-bottom-color: #A8A8A8;
  /* table.border.bottom.color */
}

#pzveloiefp .gt_heading {
  background-color: #FFFFFF;
  /* heading.background.color */
  border-bottom-color: #FFFFFF;
  /* table.background.color */
  border-left-style: hidden;
  /* heading.border.lr.style */
  border-left-width: 1px;
  /* heading.border.lr.width */
  border-left-color: #D3D3D3;
  /* heading.border.lr.color */
  border-right-style: hidden;
  /* heading.border.lr.style */
  border-right-width: 1px;
  /* heading.border.lr.width */
  border-right-color: #D3D3D3;
  /* heading.border.lr.color */
}

#pzveloiefp .gt_title {
  color: #333333;
  font-size: 125%;
  /* heading.title.font.size */
  font-weight: initial;
  /* heading.title.font.weight */
  padding-top: 4px;
  /* heading.top.padding - not yet used */
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  /* table.background.color */
  border-bottom-width: 0;
}

#pzveloiefp .gt_subtitle {
  color: #333333;
  font-size: 85%;
  /* heading.subtitle.font.size */
  font-weight: initial;
  /* heading.subtitle.font.weight */
  padding-top: 0;
  padding-bottom: 4px;
  /* heading.bottom.padding - not yet used */
  border-top-color: #FFFFFF;
  /* table.background.color */
  border-top-width: 0;
}

#pzveloiefp .gt_bottom_border {
  border-bottom-style: solid;
  /* heading.border.bottom.style */
  border-bottom-width: 2px;
  /* heading.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* heading.border.bottom.color */
}

#pzveloiefp .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  padding-top: 4px;
  padding-bottom: 4px;
}

#pzveloiefp .gt_col_headings {
  border-top-style: solid;
  /* column_labels.border.top.style */
  border-top-width: 2px;
  /* column_labels.border.top.width */
  border-top-color: #D3D3D3;
  /* column_labels.border.top.color */
  border-bottom-style: solid;
  /* column_labels.border.bottom.style */
  border-bottom-width: 2px;
  /* column_labels.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* column_labels.border.bottom.color */
  border-left-style: none;
  /* column_labels.border.lr.style */
  border-left-width: 1px;
  /* column_labels.border.lr.width */
  border-left-color: #D3D3D3;
  /* column_labels.border.lr.color */
  border-right-style: none;
  /* column_labels.border.lr.style */
  border-right-width: 1px;
  /* column_labels.border.lr.width */
  border-right-color: #D3D3D3;
  /* column_labels.border.lr.color */
}

#pzveloiefp .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  /* column_labels.background.color */
  font-size: 100%;
  /* column_labels.font.size */
  font-weight: initial;
  /* column_labels.font.weight */
  text-transform: inherit;
  /* column_labels.text_transform */
  vertical-align: middle;
  padding: 5px;
  margin: 10px;
  overflow-x: hidden;
}

#pzveloiefp .gt_sep_right {
  border-right: 5px solid #FFFFFF;
}

#pzveloiefp .gt_group_heading {
  padding: 8px;
  /* row_group.padding */
  color: #333333;
  background-color: #FFFFFF;
  /* row_group.background.color */
  font-size: 100%;
  /* row_group.font.size */
  font-weight: initial;
  /* row_group.font.weight */
  text-transform: inherit;
  /* row_group.text_transform */
  border-top-style: solid;
  /* row_group.border.top.style */
  border-top-width: 2px;
  /* row_group.border.top.width */
  border-top-color: #D3D3D3;
  /* row_group.border.top.color */
  border-bottom-style: solid;
  /* row_group.border.bottom.style */
  border-bottom-width: 2px;
  /* row_group.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* row_group.border.bottom.color */
  border-left-style: none;
  /* row_group.border.left.style */
  border-left-width: 1px;
  /* row_group.border.left.width */
  border-left-color: #D3D3D3;
  /* row_group.border.left.color */
  border-right-style: none;
  /* row_group.border.right.style */
  border-right-width: 1px;
  /* row_group.border.right.width */
  border-right-color: #D3D3D3;
  /* row_group.border.right.color */
  vertical-align: middle;
}

#pzveloiefp .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  /* row_group.background.color */
  font-size: 100%;
  /* row_group.font.size */
  font-weight: initial;
  /* row_group.font.weight */
  border-top-style: solid;
  /* row_group.border.top.style */
  border-top-width: 2px;
  /* row_group.border.top.width */
  border-top-color: #D3D3D3;
  /* row_group.border.top.color */
  border-bottom-style: solid;
  /* row_group.border.bottom.style */
  border-bottom-width: 2px;
  /* row_group.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* row_group.border.bottom.color */
  vertical-align: middle;
}

#pzveloiefp .gt_striped {
  background-color: #8080800D;
  /* row.striping.background_color */
}

#pzveloiefp .gt_from_md > :first-child {
  margin-top: 0;
}

#pzveloiefp .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pzveloiefp .gt_row {
  padding-top: 8px;
  /* data_row.padding */
  padding-bottom: 8px;
  /* data_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  /* table_body.hlines.style */
  border-top-width: 1px;
  /* table_body.hlines.width */
  border-top-color: #D3D3D3;
  /* table_body.hlines.color */
  border-left-style: none;
  /* table_body.vlines.style */
  border-left-width: 1px;
  /* table_body.vlines.width */
  border-left-color: #D3D3D3;
  /* table_body.vlines.color */
  border-right-style: none;
  /* table_body.vlines.style */
  border-right-width: 1px;
  /* table_body.vlines.width */
  border-right-color: #D3D3D3;
  /* table_body.vlines.color */
  vertical-align: middle;
  overflow-x: hidden;
}

#pzveloiefp .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  /* stub.background.color */
  font-weight: initial;
  /* stub.font.weight */
  text-transform: inherit;
  /* stub.text_transform */
  border-right-style: solid;
  /* stub.border.style */
  border-right-width: 2px;
  /* stub.border.width */
  border-right-color: #D3D3D3;
  /* stub.border.color */
  padding-left: 12px;
}

#pzveloiefp .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  /* summary_row.background.color */
  text-transform: inherit;
  /* summary_row.text_transform */
  padding-top: 8px;
  /* summary_row.padding */
  padding-bottom: 8px;
  /* summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
}

#pzveloiefp .gt_first_summary_row {
  padding-top: 8px;
  /* summary_row.padding */
  padding-bottom: 8px;
  /* summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  /* summary_row.border.style */
  border-top-width: 2px;
  /* summary_row.border.width */
  border-top-color: #D3D3D3;
  /* summary_row.border.color */
}

#pzveloiefp .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  /* grand_summary_row.background.color */
  text-transform: inherit;
  /* grand_summary_row.text_transform */
  padding-top: 8px;
  /* grand_summary_row.padding */
  padding-bottom: 8px;
  /* grand_summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
}

#pzveloiefp .gt_first_grand_summary_row {
  padding-top: 8px;
  /* grand_summary_row.padding */
  padding-bottom: 8px;
  /* grand_summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  /* grand_summary_row.border.style */
  border-top-width: 6px;
  /* grand_summary_row.border.width */
  border-top-color: #D3D3D3;
  /* grand_summary_row.border.color */
}

#pzveloiefp .gt_table_body {
  border-top-style: solid;
  /* table_body.border.top.style */
  border-top-width: 2px;
  /* table_body.border.top.width */
  border-top-color: #D3D3D3;
  /* table_body.border.top.color */
  border-bottom-style: solid;
  /* table_body.border.bottom.style */
  border-bottom-width: 2px;
  /* table_body.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* table_body.border.bottom.color */
}

#pzveloiefp .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  /* footnotes.background.color */
  border-bottom-style: none;
  /* footnotes.border.bottom.style */
  border-bottom-width: 2px;
  /* footnotes.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* footnotes.border.bottom.color */
  border-left-style: none;
  /* footnotes.border.lr.color */
  border-left-width: 2px;
  /* footnotes.border.lr.color */
  border-left-color: #D3D3D3;
  /* footnotes.border.lr.color */
  border-right-style: none;
  /* footnotes.border.lr.color */
  border-right-width: 2px;
  /* footnotes.border.lr.color */
  border-right-color: #D3D3D3;
  /* footnotes.border.lr.color */
}

#pzveloiefp .gt_footnote {
  margin: 0px;
  font-size: 90%;
  /* footnotes.font.size */
  padding: 4px;
  /* footnotes.padding */
}

#pzveloiefp .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  /* source_notes.background.color */
  border-bottom-style: none;
  /* source_notes.border.bottom.style */
  border-bottom-width: 2px;
  /* source_notes.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* source_notes.border.bottom.color */
  border-left-style: none;
  /* source_notes.border.lr.style */
  border-left-width: 2px;
  /* source_notes.border.lr.style */
  border-left-color: #D3D3D3;
  /* source_notes.border.lr.style */
  border-right-style: none;
  /* source_notes.border.lr.style */
  border-right-width: 2px;
  /* source_notes.border.lr.style */
  border-right-color: #D3D3D3;
  /* source_notes.border.lr.style */
}

#pzveloiefp .gt_sourcenote {
  font-size: 90%;
  /* source_notes.font.size */
  padding: 4px;
  /* source_notes.padding */
}

#pzveloiefp .gt_left {
  text-align: left;
}

#pzveloiefp .gt_center {
  text-align: center;
}

#pzveloiefp .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pzveloiefp .gt_font_normal {
  font-weight: normal;
}

#pzveloiefp .gt_font_bold {
  font-weight: bold;
}

#pzveloiefp .gt_font_italic {
  font-style: italic;
}

#pzveloiefp .gt_super {
  font-size: 65%;
}

#pzveloiefp .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="pzveloiefp" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">Sales Channel</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">unique_dates</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">start_date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">end_date</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">total_sales</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">days_span</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">Online</td>
      <td class="gt_row gt_center">38</td>
      <td class="gt_row gt_left">2011-05-01</td>
      <td class="gt_row gt_left">2014-06-01</td>
      <td class="gt_row gt_right">29358677</td>
      <td class="gt_row gt_center">1127 days</td>
    </tr>
    <tr>
      <td class="gt_row gt_left gt_striped">Sales Rep</td>
      <td class="gt_row gt_center gt_striped">34</td>
      <td class="gt_row gt_left gt_striped">2011-05-01</td>
      <td class="gt_row gt_left gt_striped">2014-05-01</td>
      <td class="gt_row gt_right gt_striped">80487704</td>
      <td class="gt_row gt_center gt_striped">1096 days</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>As this table shows, the <strong>Sales Rep</strong> dates don’t match the <strong>Online</strong> dates. They start on the same date, but have a different end. The <strong>Online</strong> dates include 2 months that are not included in the Sales Rep sales (which are the main sales channel by dollar volume).</p>
</div>
<div id="monthly-variation-compared-to-a-trend-line" class="section level3">
<h3><span class="header-section-number">8.7.2</span> Monthly variation compared to a trend line</h3>
<p>Jumping to the trend line comparison, we see that the big the source of variation is on the Sales Rep side.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1"><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb140-2" data-line-number="2">  <span class="dt">data =</span> monthly_sales_w_channel,</a>
<a class="sourceLine" id="cb140-3" data-line-number="3">  <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">    <span class="dt">x =</span> orderdate, <span class="dt">y =</span> total_soh_dollars</a>
<a class="sourceLine" id="cb140-5" data-line-number="5">  )</a>
<a class="sourceLine" id="cb140-6" data-line-number="6">) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb140-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-9" data-line-number="9"><span class="st">  </span><span class="kw">facet_grid</span>(<span class="st">&quot;onlineorderflag&quot;</span>, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-10" data-line-number="10"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_x_date</span>(<span class="dt">date_breaks =</span> <span class="st">&quot;year&quot;</span>, <span class="dt">date_labels =</span> <span class="st">&quot;%Y&quot;</span>, <span class="dt">date_minor_breaks =</span> <span class="st">&quot;3 months&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb140-12" data-line-number="12"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">.5</span>)) <span class="op">+</span><span class="st"> </span><span class="co"># Center ggplot title</span></a>
<a class="sourceLine" id="cb140-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb140-14" data-line-number="14">    <span class="dt">title =</span> <span class="kw">glue</span>(</a>
<a class="sourceLine" id="cb140-15" data-line-number="15">      <span class="st">&quot;AdventureWorks Monthly Sales Trend&quot;</span></a>
<a class="sourceLine" id="cb140-16" data-line-number="16">    ),</a>
<a class="sourceLine" id="cb140-17" data-line-number="17">    <span class="dt">x =</span> <span class="kw">glue</span>( <span class="st">&quot;Month - between &quot;</span>, {<span class="kw">format</span>(min_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)} , <span class="st">&quot; - &quot;</span>, </a>
<a class="sourceLine" id="cb140-18" data-line-number="18">           {<span class="kw">format</span>(max_soh_dt, <span class="st">&quot;%B %d, %Y&quot;</span>)}),</a>
<a class="sourceLine" id="cb140-19" data-line-number="19">    <span class="dt">y =</span> <span class="st">&quot;Sales Dollars&quot;</span></a>
<a class="sourceLine" id="cb140-20" data-line-number="20">  )</a></code></pre></div>
<div class="figure">
<img src="083-exploring-a-single-table_files/figure-html/average%20dollars-1.png" alt="Monthly Sales Trend" width="672" />
<p class="caption">
(#fig:average dollars)Monthly Sales Trend
</p>
</div>
<p>The <strong>monthly</strong> gyrations are much larger on the Sales Rep side, amounting to differences in a million dollars compared to small monthly variations of around $25,000 for the Online orders.</p>
</div>
<div id="compare-monthly-lagged-data-by-sales-channel" class="section level3">
<h3><span class="header-section-number">8.7.3</span> Compare monthly lagged data by Sales Channel</h3>
<p>First consider month-to-month change.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" data-line-number="1">monthly_sales_w_channel_lagged_by_month &lt;-<span class="st"> </span>monthly_sales_w_channel <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb141-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb141-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb141-4" data-line-number="4">    <span class="dt">lag_soh_count =</span> <span class="kw">lag</span>(soh_count, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb141-5" data-line-number="5">    <span class="dt">lag_soh_total_dollars =</span> <span class="kw">lag</span>(total_soh_dollars, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb141-6" data-line-number="6">    <span class="dt">pct_monthly_soh_dollar_change =</span></a>
<a class="sourceLine" id="cb141-7" data-line-number="7">      (total_soh_dollars <span class="op">-</span><span class="st"> </span>lag_soh_total_dollars) <span class="op">/</span><span class="st"> </span>lag_soh_total_dollars <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb141-8" data-line-number="8">    <span class="dt">pct_monthly_soh_count_change =</span></a>
<a class="sourceLine" id="cb141-9" data-line-number="9">      (soh_count <span class="op">-</span><span class="st"> </span>lag_soh_count) <span class="op">/</span><span class="st"> </span>lag_soh_count <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb141-10" data-line-number="10">  )</a></code></pre></div>
<p>The following table shows some wild changes in dollar amounts and number of sales from one month to the next.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1">monthly_sales_w_channel_lagged_by_month <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">abs</span>(pct_monthly_soh_count_change) <span class="op">&gt;</span><span class="st"> </span><span class="dv">150</span> <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-3" data-line-number="3"><span class="st">         </span><span class="kw">abs</span>(pct_monthly_soh_dollar_change) <span class="op">&gt;</span><span class="st"> </span><span class="dv">150</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(onlineorderflag, orderdate) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb142-7" data-line-number="7">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(total_soh_dollars),</a>
<a class="sourceLine" id="cb142-8" data-line-number="8">    <span class="dt">lag_soh_total_dollars =</span> <span class="kw">round</span>(lag_soh_total_dollars),</a>
<a class="sourceLine" id="cb142-9" data-line-number="9">    <span class="dt">pct_monthly_soh_dollar_change =</span> <span class="kw">round</span>(pct_monthly_soh_dollar_change),</a>
<a class="sourceLine" id="cb142-10" data-line-number="10">    <span class="dt">pct_monthly_soh_count_change =</span> <span class="kw">round</span>(pct_monthly_soh_count_change)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(orderdate, onlineorderflag,  total_soh_dollars, lag_soh_total_dollars, </a>
<a class="sourceLine" id="cb142-12" data-line-number="12">         soh_count, lag_soh_count, pct_monthly_soh_dollar_change, pct_monthly_soh_count_change) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-13" data-line-number="13"><span class="st">  </span><span class="co"># names()</span></a>
<a class="sourceLine" id="cb142-14" data-line-number="14"><span class="st">  </span><span class="kw">gt</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-15" data-line-number="15"><span class="st">  </span><span class="kw">fmt_number</span>(</a>
<a class="sourceLine" id="cb142-16" data-line-number="16">    <span class="dt">columns =</span> <span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">4</span>), <span class="dt">decimals =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-17" data-line-number="17"><span class="st">  </span><span class="kw">fmt_percent</span>(</a>
<a class="sourceLine" id="cb142-18" data-line-number="18">    <span class="dt">columns =</span> <span class="kw">c</span>(<span class="dv">7</span><span class="op">:</span><span class="dv">8</span>), <span class="dt">decimals =</span> <span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-19" data-line-number="19"><span class="st">  </span><span class="kw">cols_label</span>(</a>
<a class="sourceLine" id="cb142-20" data-line-number="20">    <span class="dt">onlineorderflag =</span> <span class="st">&quot;Channel&quot;</span>,</a>
<a class="sourceLine" id="cb142-21" data-line-number="21">    <span class="dt">total_soh_dollars =</span> <span class="st">&quot;$ this Month&quot;</span>,</a>
<a class="sourceLine" id="cb142-22" data-line-number="22">    <span class="dt">lag_soh_total_dollars =</span> <span class="st">&quot;$ last Month&quot;</span>,</a>
<a class="sourceLine" id="cb142-23" data-line-number="23">    <span class="dt">soh_count =</span> <span class="st">&quot;# this Month&quot;</span>,</a>
<a class="sourceLine" id="cb142-24" data-line-number="24">    <span class="dt">lag_soh_count =</span> <span class="st">&quot;# last Month&quot;</span>,</a>
<a class="sourceLine" id="cb142-25" data-line-number="25">    <span class="dt">pct_monthly_soh_dollar_change =</span> <span class="st">&quot;$ change&quot;</span>,</a>
<a class="sourceLine" id="cb142-26" data-line-number="26">    <span class="dt">pct_monthly_soh_count_change =</span> <span class="st">&quot;# change&quot;</span></a>
<a class="sourceLine" id="cb142-27" data-line-number="27">  )</a></code></pre></div>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#dbgvzfontn .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  /* table.margin.left */
  margin-right: auto;
  /* table.margin.right */
  color: #333333;
  font-size: 16px;
  /* table.font.size */
  background-color: #FFFFFF;
  /* table.background.color */
  width: auto;
  /* table.width */
  border-top-style: solid;
  /* table.border.top.style */
  border-top-width: 2px;
  /* table.border.top.width */
  border-top-color: #A8A8A8;
  /* table.border.top.color */
  border-bottom-style: solid;
  /* table.border.bottom.style */
  border-bottom-width: 2px;
  /* table.border.bottom.width */
  border-bottom-color: #A8A8A8;
  /* table.border.bottom.color */
}

#dbgvzfontn .gt_heading {
  background-color: #FFFFFF;
  /* heading.background.color */
  border-bottom-color: #FFFFFF;
  /* table.background.color */
  border-left-style: hidden;
  /* heading.border.lr.style */
  border-left-width: 1px;
  /* heading.border.lr.width */
  border-left-color: #D3D3D3;
  /* heading.border.lr.color */
  border-right-style: hidden;
  /* heading.border.lr.style */
  border-right-width: 1px;
  /* heading.border.lr.width */
  border-right-color: #D3D3D3;
  /* heading.border.lr.color */
}

#dbgvzfontn .gt_title {
  color: #333333;
  font-size: 125%;
  /* heading.title.font.size */
  font-weight: initial;
  /* heading.title.font.weight */
  padding-top: 4px;
  /* heading.top.padding - not yet used */
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  /* table.background.color */
  border-bottom-width: 0;
}

#dbgvzfontn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  /* heading.subtitle.font.size */
  font-weight: initial;
  /* heading.subtitle.font.weight */
  padding-top: 0;
  padding-bottom: 4px;
  /* heading.bottom.padding - not yet used */
  border-top-color: #FFFFFF;
  /* table.background.color */
  border-top-width: 0;
}

#dbgvzfontn .gt_bottom_border {
  border-bottom-style: solid;
  /* heading.border.bottom.style */
  border-bottom-width: 2px;
  /* heading.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* heading.border.bottom.color */
}

#dbgvzfontn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  padding-top: 4px;
  padding-bottom: 4px;
}

#dbgvzfontn .gt_col_headings {
  border-top-style: solid;
  /* column_labels.border.top.style */
  border-top-width: 2px;
  /* column_labels.border.top.width */
  border-top-color: #D3D3D3;
  /* column_labels.border.top.color */
  border-bottom-style: solid;
  /* column_labels.border.bottom.style */
  border-bottom-width: 2px;
  /* column_labels.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* column_labels.border.bottom.color */
  border-left-style: none;
  /* column_labels.border.lr.style */
  border-left-width: 1px;
  /* column_labels.border.lr.width */
  border-left-color: #D3D3D3;
  /* column_labels.border.lr.color */
  border-right-style: none;
  /* column_labels.border.lr.style */
  border-right-width: 1px;
  /* column_labels.border.lr.width */
  border-right-color: #D3D3D3;
  /* column_labels.border.lr.color */
}

#dbgvzfontn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  /* column_labels.background.color */
  font-size: 100%;
  /* column_labels.font.size */
  font-weight: initial;
  /* column_labels.font.weight */
  text-transform: inherit;
  /* column_labels.text_transform */
  vertical-align: middle;
  padding: 5px;
  margin: 10px;
  overflow-x: hidden;
}

#dbgvzfontn .gt_sep_right {
  border-right: 5px solid #FFFFFF;
}

#dbgvzfontn .gt_group_heading {
  padding: 8px;
  /* row_group.padding */
  color: #333333;
  background-color: #FFFFFF;
  /* row_group.background.color */
  font-size: 100%;
  /* row_group.font.size */
  font-weight: initial;
  /* row_group.font.weight */
  text-transform: inherit;
  /* row_group.text_transform */
  border-top-style: solid;
  /* row_group.border.top.style */
  border-top-width: 2px;
  /* row_group.border.top.width */
  border-top-color: #D3D3D3;
  /* row_group.border.top.color */
  border-bottom-style: solid;
  /* row_group.border.bottom.style */
  border-bottom-width: 2px;
  /* row_group.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* row_group.border.bottom.color */
  border-left-style: none;
  /* row_group.border.left.style */
  border-left-width: 1px;
  /* row_group.border.left.width */
  border-left-color: #D3D3D3;
  /* row_group.border.left.color */
  border-right-style: none;
  /* row_group.border.right.style */
  border-right-width: 1px;
  /* row_group.border.right.width */
  border-right-color: #D3D3D3;
  /* row_group.border.right.color */
  vertical-align: middle;
}

#dbgvzfontn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  /* row_group.background.color */
  font-size: 100%;
  /* row_group.font.size */
  font-weight: initial;
  /* row_group.font.weight */
  border-top-style: solid;
  /* row_group.border.top.style */
  border-top-width: 2px;
  /* row_group.border.top.width */
  border-top-color: #D3D3D3;
  /* row_group.border.top.color */
  border-bottom-style: solid;
  /* row_group.border.bottom.style */
  border-bottom-width: 2px;
  /* row_group.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* row_group.border.bottom.color */
  vertical-align: middle;
}

#dbgvzfontn .gt_striped {
  background-color: #8080800D;
  /* row.striping.background_color */
}

#dbgvzfontn .gt_from_md > :first-child {
  margin-top: 0;
}

#dbgvzfontn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dbgvzfontn .gt_row {
  padding-top: 8px;
  /* data_row.padding */
  padding-bottom: 8px;
  /* data_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  /* table_body.hlines.style */
  border-top-width: 1px;
  /* table_body.hlines.width */
  border-top-color: #D3D3D3;
  /* table_body.hlines.color */
  border-left-style: none;
  /* table_body.vlines.style */
  border-left-width: 1px;
  /* table_body.vlines.width */
  border-left-color: #D3D3D3;
  /* table_body.vlines.color */
  border-right-style: none;
  /* table_body.vlines.style */
  border-right-width: 1px;
  /* table_body.vlines.width */
  border-right-color: #D3D3D3;
  /* table_body.vlines.color */
  vertical-align: middle;
  overflow-x: hidden;
}

#dbgvzfontn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  /* stub.background.color */
  font-weight: initial;
  /* stub.font.weight */
  text-transform: inherit;
  /* stub.text_transform */
  border-right-style: solid;
  /* stub.border.style */
  border-right-width: 2px;
  /* stub.border.width */
  border-right-color: #D3D3D3;
  /* stub.border.color */
  padding-left: 12px;
}

#dbgvzfontn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  /* summary_row.background.color */
  text-transform: inherit;
  /* summary_row.text_transform */
  padding-top: 8px;
  /* summary_row.padding */
  padding-bottom: 8px;
  /* summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_first_summary_row {
  padding-top: 8px;
  /* summary_row.padding */
  padding-bottom: 8px;
  /* summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  /* summary_row.border.style */
  border-top-width: 2px;
  /* summary_row.border.width */
  border-top-color: #D3D3D3;
  /* summary_row.border.color */
}

#dbgvzfontn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  /* grand_summary_row.background.color */
  text-transform: inherit;
  /* grand_summary_row.text_transform */
  padding-top: 8px;
  /* grand_summary_row.padding */
  padding-bottom: 8px;
  /* grand_summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
}

#dbgvzfontn .gt_first_grand_summary_row {
  padding-top: 8px;
  /* grand_summary_row.padding */
  padding-bottom: 8px;
  /* grand_summary_row.padding */
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  /* grand_summary_row.border.style */
  border-top-width: 6px;
  /* grand_summary_row.border.width */
  border-top-color: #D3D3D3;
  /* grand_summary_row.border.color */
}

#dbgvzfontn .gt_table_body {
  border-top-style: solid;
  /* table_body.border.top.style */
  border-top-width: 2px;
  /* table_body.border.top.width */
  border-top-color: #D3D3D3;
  /* table_body.border.top.color */
  border-bottom-style: solid;
  /* table_body.border.bottom.style */
  border-bottom-width: 2px;
  /* table_body.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* table_body.border.bottom.color */
}

#dbgvzfontn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  /* footnotes.background.color */
  border-bottom-style: none;
  /* footnotes.border.bottom.style */
  border-bottom-width: 2px;
  /* footnotes.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* footnotes.border.bottom.color */
  border-left-style: none;
  /* footnotes.border.lr.color */
  border-left-width: 2px;
  /* footnotes.border.lr.color */
  border-left-color: #D3D3D3;
  /* footnotes.border.lr.color */
  border-right-style: none;
  /* footnotes.border.lr.color */
  border-right-width: 2px;
  /* footnotes.border.lr.color */
  border-right-color: #D3D3D3;
  /* footnotes.border.lr.color */
}

#dbgvzfontn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  /* footnotes.font.size */
  padding: 4px;
  /* footnotes.padding */
}

#dbgvzfontn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  /* source_notes.background.color */
  border-bottom-style: none;
  /* source_notes.border.bottom.style */
  border-bottom-width: 2px;
  /* source_notes.border.bottom.width */
  border-bottom-color: #D3D3D3;
  /* source_notes.border.bottom.color */
  border-left-style: none;
  /* source_notes.border.lr.style */
  border-left-width: 2px;
  /* source_notes.border.lr.style */
  border-left-color: #D3D3D3;
  /* source_notes.border.lr.style */
  border-right-style: none;
  /* source_notes.border.lr.style */
  border-right-width: 2px;
  /* source_notes.border.lr.style */
  border-right-color: #D3D3D3;
  /* source_notes.border.lr.style */
}

#dbgvzfontn .gt_sourcenote {
  font-size: 90%;
  /* source_notes.font.size */
  padding: 4px;
  /* source_notes.padding */
}

#dbgvzfontn .gt_left {
  text-align: left;
}

#dbgvzfontn .gt_center {
  text-align: center;
}

#dbgvzfontn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dbgvzfontn .gt_font_normal {
  font-weight: normal;
}

#dbgvzfontn .gt_font_bold {
  font-weight: bold;
}

#dbgvzfontn .gt_font_italic {
  font-style: italic;
}

#dbgvzfontn .gt_super {
  font-size: 65%;
}

#dbgvzfontn .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="dbgvzfontn" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">orderdate</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">Channel</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">$ this Month</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">$ last Month</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"># this Month</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"># last Month</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">$ change</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1"># change</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_left">2011-06-01</td>
      <td class="gt_row gt_left">Online</td>
      <td class="gt_row gt_right">458,911</td>
      <td class="gt_row gt_right">14,477</td>
      <td class="gt_row gt_center">141</td>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">307,000&percnt;</td>
      <td class="gt_row gt_right">272,000&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left gt_striped">2013-07-01</td>
      <td class="gt_row gt_left gt_striped">Online</td>
      <td class="gt_row gt_right gt_striped">847,139</td>
      <td class="gt_row gt_right gt_striped">860,141</td>
      <td class="gt_row gt_center gt_striped">1564</td>
      <td class="gt_row gt_center gt_striped">533</td>
      <td class="gt_row gt_right gt_striped">&minus;200&percnt;</td>
      <td class="gt_row gt_right gt_striped">19,300&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">2011-07-01</td>
      <td class="gt_row gt_left">Sales Rep</td>
      <td class="gt_row gt_right">1,538,408</td>
      <td class="gt_row gt_right">489,329</td>
      <td class="gt_row gt_center">75</td>
      <td class="gt_row gt_center">38</td>
      <td class="gt_row gt_right">21,400&percnt;</td>
      <td class="gt_row gt_right">9,700&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left gt_striped">2012-01-01</td>
      <td class="gt_row gt_left gt_striped">Sales Rep</td>
      <td class="gt_row gt_right gt_striped">3,356,069</td>
      <td class="gt_row gt_right gt_striped">713,117</td>
      <td class="gt_row gt_center gt_striped">143</td>
      <td class="gt_row gt_center gt_striped">40</td>
      <td class="gt_row gt_right gt_striped">37,100&percnt;</td>
      <td class="gt_row gt_right gt_striped">25,800&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">2012-03-01</td>
      <td class="gt_row gt_left">Sales Rep</td>
      <td class="gt_row gt_right">2,269,117</td>
      <td class="gt_row gt_right">882,900</td>
      <td class="gt_row gt_center">85</td>
      <td class="gt_row gt_center">37</td>
      <td class="gt_row gt_right">15,700&percnt;</td>
      <td class="gt_row gt_right">13,000&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left gt_striped">2014-03-01</td>
      <td class="gt_row gt_left gt_striped">Sales Rep</td>
      <td class="gt_row gt_right gt_striped">5,526,352</td>
      <td class="gt_row gt_right gt_striped">3,231</td>
      <td class="gt_row gt_center gt_striped">271</td>
      <td class="gt_row gt_center gt_striped">3</td>
      <td class="gt_row gt_right gt_striped">17,096,000&percnt;</td>
      <td class="gt_row gt_right gt_striped">893,300&percnt;</td>
    </tr>
    <tr>
      <td class="gt_row gt_left">2014-05-01</td>
      <td class="gt_row gt_left">Sales Rep</td>
      <td class="gt_row gt_right">3,415,479</td>
      <td class="gt_row gt_right">1,285</td>
      <td class="gt_row gt_center">179</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">26,573,900&percnt;</td>
      <td class="gt_row gt_right">885,000&percnt;</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>We suspect that the business has changed a lot with the advent of <strong>Online</strong> orders.</p>
</div>
</div>
<div id="detect-and-diagnose-the-day-of-the-month-problem" class="section level2">
<h2><span class="header-section-number">8.8</span> Detect and diagnose the day of the month problem</h2>
<p>There have been several indications that Sales Rep sales are recorded once a month while Online sales are recorded on a daily basis.</p>
<div id="sales-rep-orderdate-distribution" class="section level3">
<h3><span class="header-section-number">8.8.1</span> Sales Rep Orderdate Distribution</h3>
<p>Look at the dates when sales are entered for sales by <strong>Sales Reps</strong>. The following query / plot combination shows this pattern. and the exception for transactions entered on the first day of the month.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" data-line-number="1">  <span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Drop online orders</span></a>
<a class="sourceLine" id="cb143-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orderday =</span> <span class="kw">day</span>(orderdate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>(orderday, <span class="dt">name =</span> <span class="st">&quot;Orders&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-5" data-line-number="5"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-6" data-line-number="6"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">tibble</span>(<span class="dt">orderday =</span> <span class="kw">seq</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">31</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orderday =</span> <span class="kw">as.factor</span>(orderday)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-8" data-line-number="8"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(orderday, Orders)) <span class="op">+</span></a>
<a class="sourceLine" id="cb143-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_col</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb143-10" data-line-number="10"><span class="st">  </span><span class="kw">coord_flip</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb143-11" data-line-number="11"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;The first day of the month looks odd&quot;</span>,</a>
<a class="sourceLine" id="cb143-12" data-line-number="12">       <span class="dt">x =</span> <span class="st">&quot;Day Number&quot;</span>)</a></code></pre></div>
<pre><code>## Joining, by = &quot;orderday&quot;</code></pre>
<pre><code>## Warning: Removed 26 rows containing missing values (position_stack).</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-12"></span>
<img src="083-exploring-a-single-table_files/figure-html/unnamed-chunk-12-1.png" alt="Days of the month with Sales Rep activity recorded" width="672" />
<p class="caption">
Figure 8.3: Days of the month with Sales Rep activity recorded
</p>
</div>
<p>We can check on which months have orders entered on the first of the month.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" data-line-number="1">sales_rep_day_of_month_sales &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb146-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Drop online orders</span></a>
<a class="sourceLine" id="cb146-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb146-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb146-5" data-line-number="5">    <span class="dt">year =</span> <span class="kw">year</span>(orderdate),</a>
<a class="sourceLine" id="cb146-6" data-line-number="6">    <span class="dt">month =</span> <span class="kw">month</span>(orderdate),</a>
<a class="sourceLine" id="cb146-7" data-line-number="7">    <span class="dt">day =</span> <span class="kw">day</span>(orderdate)</a>
<a class="sourceLine" id="cb146-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb146-9" data-line-number="9"><span class="st">  </span><span class="kw">count</span>(year, month, day) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb146-10" data-line-number="10"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb146-11" data-line-number="11"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> day, <span class="dt">values_from =</span> n, <span class="dt">names_prefix =</span> <span class="st">&quot;day_&quot;</span>, <span class="dt">values_fill =</span> <span class="dv">0</span> ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb146-12" data-line-number="12"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb146-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(year, month, day_<span class="dv">1</span>, day_<span class="dv">28</span>, day_<span class="dv">29</span>, day_<span class="dv">30</span>, day_<span class="dv">31</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb146-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(day_<span class="dv">1</span> <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb146-15" data-line-number="15"><span class="st">  </span><span class="kw">arrange</span>(year, month)</a>
<a class="sourceLine" id="cb146-16" data-line-number="16"></a>
<a class="sourceLine" id="cb146-17" data-line-number="17">sales_rep_day_of_month_sales</a></code></pre></div>
<pre><code>##   year month day_1 day_28 day_29 day_30 day_31
## 1 2011     7    75      0      0      0      0
## 2 2011     8    60      0      0      0     40
## 3 2011    10    90      0      0      0     63
## 4 2011    12    40      0      0      0      0
## 5 2012     1    79      0     64      0      0
## 6 2014     3    91      0      0      2    178
## 7 2014     5   179      0      0      0      0</code></pre>
<p>There are two months with multiple sales rep order days for 2011, (11/08 and 11/10), one for 2012, (1201), and two in 2014, (14/01 and 14/03). The 14/03 is the only three day sales rep order month.</p>
<p>Are there months where there were no sales recorded for the sales reps?</p>
<p>There are two approaches. The first is to generate a list of months between the beginning and end of history and compare that to the Sales Rep records</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" data-line-number="1">monthly_sales_rep_sales &lt;-<span class="st"> </span>monthly_sales_w_channel <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb148-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> &quot;Sales Rep&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb148-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orderdate =</span> <span class="kw">as.Date</span>(<span class="kw">floor_date</span>(orderdate, <span class="st">&quot;month&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb148-4" data-line-number="4"><span class="st">  </span><span class="kw">count</span>(orderdate)</a>
<a class="sourceLine" id="cb148-5" data-line-number="5"></a>
<a class="sourceLine" id="cb148-6" data-line-number="6"><span class="kw">str</span>(monthly_sales_rep_sales)</a></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    34 obs. of  2 variables:
##  $ orderdate: Date, format: &quot;2011-05-01&quot; &quot;2011-07-01&quot; ...
##  $ n        : int  1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" data-line-number="1">date_list &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">month_date =</span> <span class="kw">seq.Date</span>(<span class="kw">floor_date</span>(<span class="kw">as.Date</span>(min_soh_dt), <span class="st">&quot;month&quot;</span>), </a>
<a class="sourceLine" id="cb150-2" data-line-number="2">         <span class="kw">floor_date</span>(<span class="kw">as.Date</span>(max_soh_dt), <span class="st">&quot;month&quot;</span>), </a>
<a class="sourceLine" id="cb150-3" data-line-number="3">         <span class="dt">by =</span> <span class="st">&quot;month&quot;</span>),</a>
<a class="sourceLine" id="cb150-4" data-line-number="4">         <span class="dt">date_exists =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb150-5" data-line-number="5"></a>
<a class="sourceLine" id="cb150-6" data-line-number="6">date_list <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb150-7" data-line-number="7"><span class="st">  </span><span class="kw">anti_join</span>(monthly_sales_rep_sales, </a>
<a class="sourceLine" id="cb150-8" data-line-number="8">            <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;month_date&quot;</span> =<span class="st"> &quot;orderdate&quot;</span>) )</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   month_date date_exists
##   &lt;date&gt;     &lt;lgl&gt;      
## 1 2011-06-01 FALSE      
## 2 2011-09-01 FALSE      
## 3 2011-11-01 FALSE      
## 4 2014-06-01 FALSE</code></pre>
<ul>
<li>June, September, and November are missing for 2011.</li>
<li>June for 2014</li>
</ul>
<p>The second approach is to use the dates found in the database for online orders. Defining “complete” may not always be as simple as generating a complete list of months.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" data-line-number="1">sales_order_header_online &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb152-4" data-line-number="4">    <span class="dt">orderdate =</span> <span class="kw">date_trunc</span>(<span class="st">&#39;month&#39;</span>, orderdate)</a>
<a class="sourceLine" id="cb152-5" data-line-number="5">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb152-6" data-line-number="6"><span class="st">  </span><span class="kw">count</span>(orderdate, <span class="dt">name =</span> <span class="st">&quot;online_count&quot;</span>) </a>
<a class="sourceLine" id="cb152-7" data-line-number="7"></a>
<a class="sourceLine" id="cb152-8" data-line-number="8">sales_order_header_sales_rep &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb152-11" data-line-number="11">    <span class="dt">orderdate =</span> <span class="kw">date_trunc</span>(<span class="st">&#39;month&#39;</span>, orderdate)</a>
<a class="sourceLine" id="cb152-12" data-line-number="12">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb152-13" data-line-number="13"><span class="st">  </span><span class="kw">count</span>(orderdate, <span class="dt">name =</span> <span class="st">&quot;sales_rep_count&quot;</span>) </a>
<a class="sourceLine" id="cb152-14" data-line-number="14"></a>
<a class="sourceLine" id="cb152-15" data-line-number="15">missing_dates &lt;-<span class="st"> </span>sales_order_header_sales_rep <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-16" data-line-number="16"><span class="st">  </span><span class="kw">full_join</span>(sales_order_header_online) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-17" data-line-number="17"><span class="st">  </span><span class="kw">show_query</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb152-18" data-line-number="18"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Joining, by = &quot;orderdate&quot;</code></pre>
<pre><code>## &lt;SQL&gt;
## SELECT COALESCE(&quot;LHS&quot;.&quot;orderdate&quot;, &quot;RHS&quot;.&quot;orderdate&quot;) AS &quot;orderdate&quot;, &quot;LHS&quot;.&quot;sales_rep_count&quot; AS &quot;sales_rep_count&quot;, &quot;RHS&quot;.&quot;online_count&quot; AS &quot;online_count&quot;
## FROM (SELECT &quot;orderdate&quot;, COUNT(*) AS &quot;sales_rep_count&quot;
## FROM (SELECT &quot;salesorderid&quot;, &quot;revisionnumber&quot;, date_trunc(&#39;month&#39;, &quot;orderdate&quot;) AS &quot;orderdate&quot;, &quot;duedate&quot;, &quot;shipdate&quot;, &quot;status&quot;, &quot;onlineorderflag&quot;, &quot;purchaseordernumber&quot;, &quot;accountnumber&quot;, &quot;customerid&quot;, &quot;salespersonid&quot;, &quot;territoryid&quot;, &quot;billtoaddressid&quot;, &quot;shiptoaddressid&quot;, &quot;shipmethodid&quot;, &quot;creditcardid&quot;, &quot;creditcardapprovalcode&quot;, &quot;currencyrateid&quot;, &quot;subtotal&quot;, &quot;taxamt&quot;, &quot;freight&quot;, &quot;totaldue&quot;, &quot;comment&quot;, &quot;rowguid&quot;, &quot;modifieddate&quot;
## FROM (SELECT *
## FROM sales.salesorderheader
## WHERE (&quot;onlineorderflag&quot; = FALSE)) &quot;dbplyr_010&quot;) &quot;dbplyr_011&quot;
## GROUP BY &quot;orderdate&quot;) &quot;LHS&quot;
## FULL JOIN (SELECT &quot;orderdate&quot;, COUNT(*) AS &quot;online_count&quot;
## FROM (SELECT &quot;salesorderid&quot;, &quot;revisionnumber&quot;, date_trunc(&#39;month&#39;, &quot;orderdate&quot;) AS &quot;orderdate&quot;, &quot;duedate&quot;, &quot;shipdate&quot;, &quot;status&quot;, &quot;onlineorderflag&quot;, &quot;purchaseordernumber&quot;, &quot;accountnumber&quot;, &quot;customerid&quot;, &quot;salespersonid&quot;, &quot;territoryid&quot;, &quot;billtoaddressid&quot;, &quot;shiptoaddressid&quot;, &quot;shipmethodid&quot;, &quot;creditcardid&quot;, &quot;creditcardapprovalcode&quot;, &quot;currencyrateid&quot;, &quot;subtotal&quot;, &quot;taxamt&quot;, &quot;freight&quot;, &quot;totaldue&quot;, &quot;comment&quot;, &quot;rowguid&quot;, &quot;modifieddate&quot;
## FROM (SELECT *
## FROM sales.salesorderheader
## WHERE (&quot;onlineorderflag&quot; = TRUE)) &quot;dbplyr_012&quot;) &quot;dbplyr_013&quot;
## GROUP BY &quot;orderdate&quot;) &quot;RHS&quot;
## ON (&quot;LHS&quot;.&quot;orderdate&quot; = &quot;RHS&quot;.&quot;orderdate&quot;)</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" data-line-number="1">missing_dates &lt;-<span class="st"> </span>sales_order_header_online <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb155-2" data-line-number="2"><span class="st">  </span><span class="kw">anti_join</span>(sales_order_header_sales_rep) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb155-3" data-line-number="3"><span class="st">  </span><span class="kw">arrange</span>(orderdate) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb155-4" data-line-number="4"><span class="st">  </span><span class="kw">collect</span>()</a></code></pre></div>
<pre><code>## Joining, by = &quot;orderdate&quot;</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" data-line-number="1">missing_dates</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   orderdate           online_count
##   &lt;dttm&gt;                     &lt;int&gt;
## 1 2011-06-01 00:00:00          141
## 2 2011-09-01 00:00:00          157
## 3 2011-11-01 00:00:00          230
## 4 2014-06-01 00:00:00          939</code></pre>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" data-line-number="1"><span class="kw">str</span>(missing_dates)</a></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    4 obs. of  2 variables:
##  $ orderdate   : POSIXct, format: &quot;2011-06-01&quot; &quot;2011-09-01&quot; ...
##  $ online_count: int  141 157 230 939</code></pre>
<p>And in this case they agree!</p>
<p>discuss February issues. and stuff.</p>
<p>look at each year sepraately as a diagnostic</p>
<p>Use the same pivot strategy on the corrected data.</p>
<p>difference between detective work with a graph and just print it out. “now I see what’s driving the hint.”</p>
<p>We have xx months when we add the month before and the month after the <strong>suspicious months</strong>. We don’t know whether the problem postings have been carried forward or backward. We check for and eliminate duplicates as well.</p>
<ul>
<li>Most of the <strong>Sales Reps</strong>’ orders are entered on a single day of the month, unique days = 1. It is possible that these are monthly recurring orders that get released on a given day of the month. If that is the case, what are the <strong>Sales Reps</strong> doing the rest of the month?</li>
<li>** ?? The lines with multiple days, unique_days &gt; 1, have a noticeable higher number of orders, so_cnt, and associated so dollars.?? **</li>
</ul>
</div>
</div>
<div id="correcting-the-order-date-for-sales-reps" class="section level2">
<h2><span class="header-section-number">8.9</span> Correcting the order date for <strong>Sales Reps</strong></h2>
<div id="define-a-date-correction-function-in-r" class="section level3">
<h3><span class="header-section-number">8.9.1</span> Define a date correction function in R</h3>
<p>This code does the date-correction work on the R side:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb161-1" data-line-number="1">monthly_sales_rep_adjusted &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb161-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(orderdate) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-5" data-line-number="5"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb161-6" data-line-number="6">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb161-7" data-line-number="7">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb161-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb161-10" data-line-number="10">    <span class="dt">orderdate =</span> <span class="kw">as.Date</span>(orderdate),</a>
<a class="sourceLine" id="cb161-11" data-line-number="11">    <span class="dt">day =</span> <span class="kw">day</span>(orderdate)</a>
<a class="sourceLine" id="cb161-12" data-line-number="12">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-13" data-line-number="13"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb161-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb161-16" data-line-number="16">    <span class="dt">adjusted_orderdate =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb161-17" data-line-number="17">      day <span class="op">==</span><span class="st"> </span>1L <span class="op">~</span><span class="st"> </span>orderdate <span class="dv">-1</span>,</a>
<a class="sourceLine" id="cb161-18" data-line-number="18">      <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>orderdate</a>
<a class="sourceLine" id="cb161-19" data-line-number="19">    ),</a>
<a class="sourceLine" id="cb161-20" data-line-number="20">    <span class="dt">year_month =</span> <span class="kw">floor_date</span>(adjusted_orderdate, <span class="st">&quot;month&quot;</span>)</a>
<a class="sourceLine" id="cb161-21" data-line-number="21">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb161-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(year_month) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb161-23" data-line-number="23"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb161-24" data-line-number="24">      <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(total_soh_dollars, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb161-25" data-line-number="25">      <span class="dt">soh_count =</span> <span class="kw">sum</span>(soh_count)</a>
<a class="sourceLine" id="cb161-26" data-line-number="26">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb161-27" data-line-number="27"><span class="st">  </span><span class="kw">ungroup</span>()</a></code></pre></div>
<p>Inspect:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb162-1" data-line-number="1"><span class="kw">str</span>(monthly_sales_rep_adjusted)</a></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    36 obs. of  3 variables:
##  $ year_month       : Date, format: &quot;2011-05-01&quot; &quot;2011-06-01&quot; ...
##  $ total_soh_dollars: num  489329 1538408 1165897 844721 2324136 ...
##  $ soh_count        : int  38 75 60 40 90 63 40 79 64 37 ...</code></pre>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb164-1" data-line-number="1">monthly_sales_rep_adjusted <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">year</span>(year_month) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2011</span>,<span class="dv">2014</span>))</a></code></pre></div>
<pre><code>## # A tibble: 12 x 3
##    year_month total_soh_dollars soh_count
##    &lt;date&gt;                 &lt;dbl&gt;     &lt;int&gt;
##  1 2011-05-01           489329.        38
##  2 2011-06-01          1538408.        75
##  3 2011-07-01          1165897.        60
##  4 2011-08-01           844721         40
##  5 2011-09-01          2324136.        90
##  6 2011-10-01          1702945.        63
##  7 2011-11-01           713117.        40
##  8 2011-12-01          1900789.        79
##  9 2014-01-01          2738752.       175
## 10 2014-02-01          2207772.        94
## 11 2014-03-01          3321810.       180
## 12 2014-04-01          3416764.       181</code></pre>
</div>
<div id="define-postgres-date-function" class="section level3">
<h3><span class="header-section-number">8.9.2</span> Define and store a PostgreSQL function to correct the date</h3>
<p>The following code defines a function on the server side to correct the date:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb166-1" data-line-number="1"><span class="kw">dbExecute</span>(</a>
<a class="sourceLine" id="cb166-2" data-line-number="2">  con,</a>
<a class="sourceLine" id="cb166-3" data-line-number="3">  <span class="st">&quot;CREATE OR REPLACE FUNCTION so_adj_date(so_date timestamp, ONLINE_ORDER boolean) RETURNS timestamp AS $$</span></a>
<a class="sourceLine" id="cb166-4" data-line-number="4"><span class="st">     BEGIN</span></a>
<a class="sourceLine" id="cb166-5" data-line-number="5"><span class="st">        IF (ONLINE_ORDER) THEN</span></a>
<a class="sourceLine" id="cb166-6" data-line-number="6"><span class="st">            RETURN (SELECT so_date);</span></a>
<a class="sourceLine" id="cb166-7" data-line-number="7"><span class="st">        ELSE</span></a>
<a class="sourceLine" id="cb166-8" data-line-number="8"><span class="st">            RETURN(SELECT CASE WHEN EXTRACT(DAY FROM so_date) = 1</span></a>
<a class="sourceLine" id="cb166-9" data-line-number="9"><span class="st">                               THEN  so_date - &#39;1 day&#39;::interval</span></a>
<a class="sourceLine" id="cb166-10" data-line-number="10"><span class="st">                               ELSE  so_date</span></a>
<a class="sourceLine" id="cb166-11" data-line-number="11"><span class="st">                          END</span></a>
<a class="sourceLine" id="cb166-12" data-line-number="12"><span class="st">                  );</span></a>
<a class="sourceLine" id="cb166-13" data-line-number="13"><span class="st">        END IF;</span></a>
<a class="sourceLine" id="cb166-14" data-line-number="14"><span class="st"> END; $$</span></a>
<a class="sourceLine" id="cb166-15" data-line-number="15"><span class="st">LANGUAGE PLPGSQL;</span></a>
<a class="sourceLine" id="cb166-16" data-line-number="16"><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb166-17" data-line-number="17">)</a></code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="use-the-postgresql-function" class="section level3">
<h3><span class="header-section-number">8.9.3</span> Use the PostgreSQL function</h3>
<p>If you can do the heavy lifting on the database side, that’s good. R can do it, but it’s best for finding the issues.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" data-line-number="1">monthly_sales_rep_adjusted_with_psql_function &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="kw">in_schema</span>(<span class="st">&quot;sales&quot;</span>, <span class="st">&quot;salesorderheader&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(orderdate, subtotal, onlineorderflag) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb168-4" data-line-number="4">    <span class="dt">orderdate =</span> <span class="kw">as.Date</span>(orderdate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">adjusted_orderdate =</span> <span class="kw">as.Date</span>(<span class="kw">so_adj_date</span>(orderdate, onlineorderflag))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(adjusted_orderdate) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-8" data-line-number="8"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb168-9" data-line-number="9">    <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(subtotal, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb168-10" data-line-number="10">    <span class="dt">soh_count =</span> <span class="kw">n</span>()</a>
<a class="sourceLine" id="cb168-11" data-line-number="11">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-12" data-line-number="12"><span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>( <span class="dt">year_month =</span> <span class="kw">floor_date</span>(adjusted_orderdate, <span class="st">&quot;month&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb168-14" data-line-number="14"><span class="st">    </span><span class="kw">group_by</span>(year_month) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb168-15" data-line-number="15"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb168-16" data-line-number="16"><span class="st">  </span><span class="kw">arrange</span>(year_month)</a></code></pre></div>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb169-1" data-line-number="1">monthly_sales_rep_adjusted_with_psql_function <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb169-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">year</span>(year_month) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2011</span>,<span class="dv">2014</span>))</a></code></pre></div>
<pre><code>## # A tibble: 14 x 4
##    adjusted_orderdate total_soh_dollars soh_count year_month
##    &lt;date&gt;                         &lt;dbl&gt;     &lt;int&gt; &lt;date&gt;    
##  1 2011-05-31                   489329.        38 2011-05-01
##  2 2011-06-30                  1538408.        75 2011-06-01
##  3 2011-07-31                  1165897.        60 2011-07-01
##  4 2011-08-31                   844721         40 2011-08-01
##  5 2011-09-30                  2324136.        90 2011-09-01
##  6 2011-10-31                  1702945.        63 2011-10-01
##  7 2011-11-30                   713117.        40 2011-11-01
##  8 2011-12-31                  1900789.        79 2011-12-01
##  9 2014-01-28                     1565.         2 2014-01-01
## 10 2014-01-29                  2737188.       173 2014-01-01
## 11 2014-02-28                  2207772.        94 2014-02-01
## 12 2014-03-30                     7291.         2 2014-03-01
## 13 2014-03-31                  3314519.       178 2014-03-01
## 14 2014-04-30                  3416764.       181 2014-04-01</code></pre>
<p>There’s one minor difference between the two:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb171-1" data-line-number="1"><span class="kw">all_equal</span>(monthly_sales_rep_adjusted, monthly_sales_rep_adjusted_with_psql_function)</a></code></pre></div>
<pre><code>## [1] &quot;Cols in y but not x: `adjusted_orderdate`. &quot;</code></pre>
</div>
<div id="monthly-sales-by-order-type-with-corrected-dates-relative-to-a-trend-line" class="section level3">
<h3><span class="header-section-number">8.9.4</span> Monthly Sales by Order Type with corrected dates – relative to a trend line</h3>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb173-1" data-line-number="1">monthly_sales_rep_as_is &lt;-<span class="st"> </span>monthly_sales_w_channel <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb173-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> &quot;Sales Rep&quot;</span>)</a>
<a class="sourceLine" id="cb173-3" data-line-number="3"></a>
<a class="sourceLine" id="cb173-4" data-line-number="4"></a>
<a class="sourceLine" id="cb173-5" data-line-number="5"><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb173-6" data-line-number="6">  <span class="dt">data =</span> monthly_sales_rep_adjusted,</a>
<a class="sourceLine" id="cb173-7" data-line-number="7">  <span class="kw">aes</span>(<span class="dt">x =</span> year_month, <span class="dt">y =</span> soh_count)</a>
<a class="sourceLine" id="cb173-8" data-line-number="8">) <span class="op">+</span></a>
<a class="sourceLine" id="cb173-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb173-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">se =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb173-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_smooth</span>(</a>
<a class="sourceLine" id="cb173-12" data-line-number="12">    <span class="dt">data =</span> monthly_sales_rep_as_is, <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb173-13" data-line-number="13">      orderdate, soh_count</a>
<a class="sourceLine" id="cb173-14" data-line-number="14">    ), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>,</a>
<a class="sourceLine" id="cb173-15" data-line-number="15">    <span class="dt">se =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb173-16" data-line-number="16">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb173-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">.5</span>)) <span class="op">+</span><span class="st"> </span><span class="co"># Center ggplot title</span></a>
<a class="sourceLine" id="cb173-18" data-line-number="18"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb173-19" data-line-number="19">    <span class="dt">title =</span> <span class="kw">glue</span>(</a>
<a class="sourceLine" id="cb173-20" data-line-number="20">      <span class="st">&quot;Number of Sales per month using corrected dates</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb173-21" data-line-number="21">      <span class="st">&quot;Counting Sales Order Header records&quot;</span></a>
<a class="sourceLine" id="cb173-22" data-line-number="22">    ),</a>
<a class="sourceLine" id="cb173-23" data-line-number="23">    <span class="dt">x =</span> <span class="kw">paste0</span>(<span class="st">&quot;Monthly - between &quot;</span>, min_soh_dt, <span class="st">&quot; - &quot;</span>, max_soh_dt),</a>
<a class="sourceLine" id="cb173-24" data-line-number="24">    <span class="dt">y =</span> <span class="st">&quot;Number of Sales Recorded&quot;</span></a>
<a class="sourceLine" id="cb173-25" data-line-number="25">  )</a></code></pre></div>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" data-line-number="1">monthly_sales_rep_as_is &lt;-<span class="st"> </span>monthly_sales_w_channel <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb174-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(onlineorderflag <span class="op">==</span><span class="st"> &quot;Sales Rep&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb174-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orderdate =</span> <span class="kw">as.Date</span>(<span class="kw">floor_date</span>(orderdate, <span class="dt">unit =</span> <span class="st">&quot;month&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb174-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(orderdate) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb174-5" data-line-number="5"><span class="st">  </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb174-6" data-line-number="6">      <span class="dt">total_soh_dollars =</span> <span class="kw">round</span>(<span class="kw">sum</span>(total_soh_dollars, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb174-7" data-line-number="7">      <span class="dt">soh_count =</span> <span class="kw">sum</span>(soh_count)</a>
<a class="sourceLine" id="cb174-8" data-line-number="8">    ) </a>
<a class="sourceLine" id="cb174-9" data-line-number="9"></a>
<a class="sourceLine" id="cb174-10" data-line-number="10">monthly_sales_rep_as_is <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb174-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">year</span>(orderdate) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2011</span>,<span class="dv">2014</span>))</a></code></pre></div>
<pre><code>## # A tibble: 10 x 3
##    orderdate  total_soh_dollars soh_count
##    &lt;date&gt;                 &lt;dbl&gt;     &lt;int&gt;
##  1 2011-05-01           489329.        38
##  2 2011-07-01          1538408.        75
##  3 2011-08-01          2010618.       100
##  4 2011-10-01          4027080.       153
##  5 2011-12-01           713117.        40
##  6 2014-01-01          2738752.       175
##  7 2014-02-01             3231.         3
##  8 2014-03-01          5526352.       271
##  9 2014-04-01             1285.         2
## 10 2014-05-01          3415479.       179</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" data-line-number="1"><span class="kw">ggplot</span>(</a>
<a class="sourceLine" id="cb176-2" data-line-number="2">  <span class="dt">data =</span> monthly_sales_rep_adjusted,</a>
<a class="sourceLine" id="cb176-3" data-line-number="3">  <span class="kw">aes</span>(<span class="dt">x =</span> year_month, <span class="dt">y =</span> soh_count)</a>
<a class="sourceLine" id="cb176-4" data-line-number="4">) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">alpha =</span> <span class="fl">.5</span> , <span class="dt">color =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">.5</span> , <span class="dt">color =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_point</span>(</a>
<a class="sourceLine" id="cb176-8" data-line-number="8">    <span class="dt">data =</span> monthly_sales_rep_as_is, <span class="kw">aes</span>(</a>
<a class="sourceLine" id="cb176-9" data-line-number="9">      orderdate, soh_count), <span class="dt">color =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-10" data-line-number="10"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">.5</span>)) <span class="op">+</span><span class="st"> </span><span class="co"># Center ggplot title</span></a>
<a class="sourceLine" id="cb176-11" data-line-number="11"><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">y =</span> <span class="dv">250</span>, <span class="dt">x =</span> <span class="kw">as.Date</span>(<span class="st">&quot;2011-06-01&quot;</span>), </a>
<a class="sourceLine" id="cb176-12" data-line-number="12">           <span class="dt">label =</span> <span class="st">&quot;Green dots: corrected data</span><span class="ch">\n</span><span class="st">Orange dots: original data</span><span class="ch">\n</span><span class="st">Brown dots: unchanged&quot;</span>,</a>
<a class="sourceLine" id="cb176-13" data-line-number="13">           <span class="dt">hjust =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb176-14" data-line-number="14"><span class="st">  </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb176-15" data-line-number="15">    <span class="dt">title =</span> <span class="kw">glue</span>(</a>
<a class="sourceLine" id="cb176-16" data-line-number="16">      <span class="st">&quot;Number of Sales per month </span><span class="ch">\n</span><span class="st">Original and corrected amounts&quot;</span></a>
<a class="sourceLine" id="cb176-17" data-line-number="17">    ),</a>
<a class="sourceLine" id="cb176-18" data-line-number="18">    <span class="dt">subtitle =</span> <span class="kw">glue</span>(<span class="st">&quot;Subtitle&quot;</span>),</a>
<a class="sourceLine" id="cb176-19" data-line-number="19">    <span class="dt">caption =</span> <span class="kw">glue</span>(<span class="st">&quot;Datasets Include: </span><span class="ch">\n</span></a>
<a class="sourceLine" id="cb176-20" data-line-number="20"><span class="st">                   monthly_sales_rep_adjusted, monthly_sales_rep_as_is&quot;</span>),</a>
<a class="sourceLine" id="cb176-21" data-line-number="21">    <span class="dt">x =</span> <span class="kw">paste0</span>(<span class="st">&quot;Monthly - between &quot;</span>, min_soh_dt, <span class="st">&quot; - &quot;</span>, max_soh_dt),</a>
<a class="sourceLine" id="cb176-22" data-line-number="22">    <span class="dt">y =</span> <span class="st">&quot;Number of Sales Recorded&quot;</span></a>
<a class="sourceLine" id="cb176-23" data-line-number="23">  )</a></code></pre></div>
<p><img src="083-exploring-a-single-table_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb177-1" data-line-number="1">mon_sales &lt;-<span class="st"> </span>monthly_sales_rep_adjusted <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb177-2" data-line-number="2"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">orderdate =</span> year_month)</a>
<a class="sourceLine" id="cb177-3" data-line-number="3"></a>
<a class="sourceLine" id="cb177-4" data-line-number="4">sales_original_and_adjusted &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(mon_sales, monthly_sales_rep_as_is, <span class="dt">.id =</span> <span class="st">&quot;date_kind&quot;</span>)</a></code></pre></div>
<p>Sales still seem to gyrate! We have found that sales rep sales data is often very strange.</p>
</div>
</div>
<div id="disconnect-from-the-database-and-stop-docker-3" class="section level2">
<h2><span class="header-section-number">8.10</span> Disconnect from the database and stop Docker</h2>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" data-line-number="1"><span class="kw">dbDisconnect</span>(con)</a>
<a class="sourceLine" id="cb178-2" data-line-number="2"><span class="co"># when running interactively use:</span></a>
<a class="sourceLine" id="cb178-3" data-line-number="3"><span class="kw">connection_close</span>(con) </a></code></pre></div>
<pre><code>## Warning in connection_release(conn@ptr): Already disconnected</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb180-1" data-line-number="1"><span class="kw">sp_docker_stop</span>(<span class="st">&quot;adventureworks&quot;</span>)</a></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="chapter-dbms-queries-intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chapter-lazy-evaluation-queries.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/smithjd/sql-pet/edit/master/083-exploring-a-single-table.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
